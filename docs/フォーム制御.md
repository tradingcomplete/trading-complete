# フォーム制御.md - トラブルシューティング知識ベース

**更新日**: 2025-12-11

---

## 1. 要素ID一覧

### 新規トレードフォーム

| 要素 | ID | 制御ファイル |
|------|-----|-------------|
| 通貨ペア | `pair` | entry-form-enhancement.js |
| オートコンプリート | `pairAutocomplete` | entry-form-enhancement.js |
| お気に入りボタン | `favoritePairBtn` | entry-form-enhancement.js |
| ブローカー | `broker` | entry-form-enhancement.js |
| ロット単位表示 | `lotUnitDisplay` | entry-form-enhancement.js |
| 売買方向 | `direction` | - |
| エントリー日時 | `entryTime` | - |
| エントリー価格 | `entryPrice` | bridge.js (step更新) |
| ロットサイズ | `lotSize` | - |
| 損切り価格 | `stopLoss` | bridge.js (step更新) |
| 利確目標価格 | `takeProfit` | bridge.js (step更新) |

### 相場ノート

| 要素 | ID | 制御ファイル |
|------|-----|-------------|
| 日付選択 | `noteDate` | NoteManagerModule.js |
| メモ入力 | `noteMemo` | NoteManagerModule.js |
| 相場観入力 | `noteMarketView` | NoteManagerModule.js |
| 週間プレビュー | `weekDays` | NoteManagerModule.js |
| 月メモタイトル | `monthlyMemoTitle` | NoteManagerModule.js |
| アノマリーセクション | `anomalySection` | NoteManagerModule.js |
| 月次メモセクション | `monthlySection` | NoteManagerModule.js |
| 検索モーダル | `noteSearchModal` | NoteManagerModule.js |
| 月メモ編集モーダル | `monthlyMemoEditModal` | NoteManagerModule.js |

### 編集モーダル

| 要素 | ID | 制御ファイル |
|------|-----|-------------|
| 通貨ペア | `editPair` | TradeEdit.js |
| オートコンプリート | `editPairAutocomplete` | TradeEdit.js |
| お気に入りボタン | `editFavoritePairBtn` | TradeEdit.js |
| ブローカー | `editBroker` | TradeEdit.js |

### トレード詳細モーダル

| 要素 | ID/関数 | 制御ファイル |
|------|---------|-------------|
| 詳細表示 | `showTradeDetail()` | bridge.js → TradeDetail.js |
| 基本情報編集 | `editBasicInfo()` | bridge.js → TradeEdit.js |
| 決済情報編集 | `editExitInfo()` | bridge.js → TradeEdit.js |
| 振り返り編集 | `editReflection()` | bridge.js → TradeDetail.js |
| 円建て損益編集 | `editYenProfitLoss()` | YenProfitLossModalModule.js |

### 画像追加モーダル

| 要素ID | 用途 | 制御ファイル |
|--------|------|-------------|
| `imageAddModal` | モーダル本体 | ImageAddModalModule.js |
| `imageDropZone` | D&Dエリア | ImageAddModalModule.js |
| `imageFileInput` | ファイル入力（非表示） | ImageAddModalModule.js |
| `externalImageUrl` | URL入力欄 | ImageAddModalModule.js |
| `selectFileBtn` | ファイル選択ボタン | ImageAddModalModule.js |
| `addUrlBtn` | URL追加ボタン | ImageAddModalModule.js |

**データフロー**:
```
トレード詳細「変更」ボタン
  ↓
ImageAddModalModule.open(type, tradeId)
  ↓
ファイル選択 or URL入力
  ↓
processLocalImage() or handleProcessedImage()
  ↓
TradeManager に保存 → UI更新
```

**イベント**: 全て addEventListener（onclick属性不使用）

---

## 2. データフロー

### 新規トレード保存

```
index.html (onclick="saveTradeRecord()")
  ↓
bridge.js (window.saveTradeRecord) ← formData作成
  ↓
TradeEntry.js (#prepareTradeData, #validateTradeData)
  ↓
TradeManager-nomodule.js (addTrade → localStorage)
```

### 価格step更新

```
通貨ペア選択
  ↓
entry-form-enhancement.js または TradeEdit.js
  ↓
bridge.js (window.updatePriceInputSteps)
  ↓
#entryPrice, #stopLoss, #takeProfit のstep属性更新
```

### 相場ノート保存

```
ノート保存ボタン (onclick="saveOrUpdateNote()")
  ↓
NoteManagerModule.js (saveOrUpdateNote → saveNote)
  ↓
  this.#notes[noteDate] = noteData
  ↓
  this.#save()
  ↓
  localStorage.setItem('notes', JSON.stringify(this.#notes))
```

⚠️ **注意**: `#save()` 内で `window.saveNotes()` を呼ぶと古いグローバル変数で上書きされる（下記バグ参照）

### 相場ノート日付連動

```
日付選択（カレンダー）
  ↓
noteDate.onchange → selectNoteDate(this.value)
  ↓
NoteManagerModule.selectNoteDate()
  ├→ #currentWeekStart を選択日付の週に更新
  ├→ updateWeeklyPreview() ← 週間プレビュー再描画
  ├→ loadNoteForDate() ← ノート読み込み
  └→ updateMonthlyMemoDisplay() ← 月メモ更新
```

### トレード詳細表示フロー（2025-11-29追加）

```
トレード一覧でトレードクリック
  ↓
bridge.js (window.showTradeDetail)
  ↓
TradeDetail.js (showTradeDetail)
  ├→ トレードデータ取得
  ├→ ステータス判定 (hasExits, isClosed, isOpen, isSettled)
  ├→ 詳細モーダルHTML生成
  └→ モーダル表示
```

### 円建て損益編集フロー（2025-11-29追加）

```
詳細モーダル内の円建て損益編集ボタン
  ↓
YenProfitLossModalModule (editYenProfitLoss)
  ↓
モーダル表示 (動的生成)
  ├→ 既存データ読み込み
  ├→ 入力フォーム表示
  └→ リアルタイム実損益計算
  ↓
保存ボタン → saveYenProfitLoss()
  ↓
YenProfitLossManager.saveYenProfitLoss()
  ↓
localStorage更新 + EventBus発火
```

### 画像処理フロー（2025-12-11追加）

```
枠クリック
  ↓
ImageAddModalModule.open(imageType, tradeId)
  ↓
window.pendingImageType = imageType（tradeChart1/2/3, noteImage）
  ↓
画像選択 → handleProcessedImage(imageData)
  ↓
pendingImageTypeで分岐:
  - tradeChart1/2/3: トレード画像更新
  - noteImage: NoteManagerModule.displayNoteImage
```

**画像統一ルール**: 常に3枠横並び、空枠は点線+「画像1/2/3」、枠クリックで追加、×で削除

---

## 3. 制御ファイル

| ファイル | 役割 |
|---------|------|
| `js/bridge.js` | formData作成、updatePriceInputSteps()、モジュール間ブリッジ |
| `js/part2/entry-form-enhancement.js` | 新規フォーム入力支援（オートコンプリート、お気に入り、ブローカー） |
| `js/part2/TradeEntry.js` | 新規トレード保存ロジック |
| `js/part2/TradeEdit.js` | 編集モーダル（同等機能） |
| `js/part2/TradeDetail.js` | トレード詳細モーダル表示・ステータス判定 |
| `js/modules/ImageAddModalModule.js` | 画像追加モーダル制御 |
| `js/part2/TradeList.js` | トレード一覧表示・フィルター |
| `js/part3_modules/NoteManagerModule.js` | 相場ノート全機能（検索、月メモ含む） |
| `js/yen-profit-loss/YenProfitLossManager.js` | 円建て損益データ管理 |
| `js/yen-profit-loss/YenProfitLossModalModule.js` | 円建て損益編集モーダル |
| `js/part5_modules/PRESET_CURRENCY_PAIRS.js` | 通貨ペアプリセット（pipValue含む） |
| `js/part5_modules/SettingsModule.js` | ブローカー管理API |
| `js/part8_modules/StatisticsModule.js` | 統計計算・EventBusリスナー |

---

## 4. LocalStorageキー

| キー | 内容 |
|------|------|
| `favoritePairs` | お気に入り通貨ペア（配列） |
| `brokers` | 登録済みブローカー |
| `trades` | トレードデータ |
| `notes` | 相場ノートデータ |
| `monthlyMemos` | 月メモ（アノマリー・月次） |
| `monthlyMemoCollapseState` | 月メモ折りたたみ状態 |
| `yenProfitLoss` | 円建て損益データ（YenProfitLossManager管理） |
| `expenses` | 経費データ |
| `capitalRecords` | 入出金記録 |

---

## 5. エラー事例

### メソッド名不一致（Phase 2.5）

```
❌ SettingsModule.getBroker() → ✅ getBrokerById()
❌ SettingsModule.editBroker() → ✅ updateBroker()
```

### undefined保存（Week 5）

**原因**: bridge.jsのformDataに新フィールドがない
**対処**: bridge.jsのformData作成部分に追加

### 初期化タイミング（Phase 4）

```javascript
// SettingsModule依存の機能はイベント待ち + フォールバック
window.EventBus.on('settings:initialized', () => initBrokerDropdown());
setTimeout(() => { if (!initialized) initBrokerDropdown(); }, 1000);

// 編集モーダルは表示後に遅延初期化
modal.style.display = 'flex';
setTimeout(() => this.#initEditPairAutocomplete(), 100);
```

### イベント重複登録

**対処**: cloneNodeパターン
```javascript
const newInput = pairInput.cloneNode(true);
pairInput.parentNode.replaceChild(newInput, pairInput);
```

---

## 6. よくあるエラーパターン

| パターン | 原因 | 対処 |
|---------|------|------|
| メソッド名不一致 | MODULES.md未確認 | Public API確認 |
| データ形式不足 | 必要フィールド不足 | データ構造確認 |
| undefined保存 | bridge.js未修正 | formData確認 |
| 初期化失敗 | タイミング問題 | EventBus + setTimeout |
| 保存データ消失 | 複数保存関数の競合 | 単一保存関数に統一 |
| UI連動しない | イベントハンドラ不足 | onchange等で連動処理追加 |
| モジュール未公開 | window登録なし | グローバル関数で確認 |

---

## 7. トレードステータス判定（2025-11-29追加）

### 判定ロジック

```javascript
// TradeDetail.js での判定
const hasExits = trade.exits && trade.exits.length > 0;
const isClosed = trade.holdingStatus === 'closed';
const isOpen = !hasExits && !isClosed;
const isSettled = hasExits || isClosed;
```

### ステータス一覧

| ステータス | 条件 | 説明 |
|-----------|------|------|
| `isOpen` | 決済なし & クローズでない | 保有中のトレード |
| `isSettled` | 決済あり or クローズ | 決済済みのトレード |
| `hasExits` | exits配列に要素あり | 決済情報が存在 |
| `isClosed` | holdingStatus === 'closed' | 明示的にクローズ |

### 関連ファイル

| ファイル | 判定箇所 | 用途 |
|---------|---------|------|
| TradeDetail.js | showTradeDetail() | 詳細モーダル表示制御 |
| TradeList.js | render() | 一覧表示スタイル |
| StatisticsModule.js | #calculateStatistics() | 統計計算対象フィルタ |
| SummaryCalculatorModule.js | calculate() | 収支計算対象フィルタ |

---

## 8. EventBusイベント一覧（2025-11-29更新）

### トレード関連

| イベント | 発火元 | リスナー |
|---------|--------|---------|
| `trade:added` | TradeManager | StatisticsModule, ChartModule, TradeList |
| `trade:updated` | TradeManager | StatisticsModule, ChartModule, TradeList |
| `trade:deleted` | TradeManager | StatisticsModule, ChartModule, TradeList |

### 円建て損益関連

| イベント | 発火元 | リスナー |
|---------|--------|---------|
| `yenProfitLoss:updated` | YenProfitLossManager | StatisticsModule |
| `yenProfitLoss:edit` | TradeDetail | YenProfitLossModalModule |

### その他

| イベント | 発火元 | リスナー |
|---------|--------|---------|
| `statistics:updated` | StatisticsModule | - |
| `expense:added` | ExpenseManagerModule | - |
| `closing:monthly` | ClosingManagerModule | - |
| `capital:recordAdded` | CapitalManagerModule | StatisticsModule |
| `settings:initialized` | SettingsModule | entry-form-enhancement.js |

### 削除されたイベント（2025-11-29）

| イベント | 理由 |
|---------|------|
| ~~`bulk:imported`~~ | 一括入力機能削除 |

---

**参照**: REFERENCE.md（デバッグフロー、即時関数パターン）

---

## 9. 修正履歴

### 一括入力機能削除（2025-11-29）🔴 CRITICAL

**実施内容**: Phase 1シンプル化のため一括入力機能を完全削除

**削除されたファイル**:
- `js/part7_modules/BulkImportModule.js`

**削除されたコード**:
- script.js: 一括入力関連関数（223行削減）
- index.html: scriptタグ2つ
- StatisticsModule.js: `bulk:imported`リスナー
- TradeDetail.js: `isBulkEntry`判定（7箇所）
- TradeList.js: `isBulkData`判定
- YenProfitLossModalModule.js: 一括入力データ注記
- bridge.js: `isBulkEntry`条件分岐

**削除されたデータ**:
- 一括入力トレード3件（`isBulkEntry: true`）

**影響**:
- トレード数: 53件 → 50件
- 統計精度: 向上（Pips情報完備のデータのみ）

**教訓**:
- 機能削除時は関連コードを全ファイル検索（grep）
- `isBulkEntry`のような判定フラグは複数ファイルに散在しやすい
- Phase 1ではシンプルさが最優先

---

### ノート保存がリロードで消える（2025-11-27）🔴 CRITICAL

**症状**: ノートを保存してもリロードするとデータが消える

**原因**: NoteManagerModule.js の `#save()` メソッドで `window.saveNotes()` を呼んでいた

```javascript
// ❌ 問題のコード
#save() {
    localStorage.setItem('notes', JSON.stringify(this.#notes));
    window.notes = this.#notes;
    if (typeof window.saveNotes === 'function') {
        window.saveNotes();  // ← これが古いデータで上書き！
    }
}
```

`window.saveNotes()` は古い実装で、グローバル変数 `window.notes` を保存する。
しかし `window.notes` は `#load()` 時点のデータしか持っていないため、
新しく追加したデータが上書きされて消える。

**修正**:
```javascript
// ✅ 正しいコード
#save() {
    localStorage.setItem('notes', JSON.stringify(this.#notes));
    window.notes = this.#notes;
    // window.saveNotes() は呼ばない
}
```

**教訓**: モジュール化時に過渡期の互換性コードを残す場合、保存処理の競合に注意

---

### カレンダー⇔週間プレビュー連動しない（2025-11-27）

**症状**: カレンダーで日付を選択しても週間プレビューが更新されない

**原因**: `noteDate` の `onchange` で `loadNoteForDate()` のみ呼んでいた

```html
<!-- ❌ 問題のコード -->
<input type="date" id="noteDate" onchange="loadNoteForDate(this.value); updateMonthlyMemoDisplay();">
```

**修正**:
```html
<!-- ✅ 正しいコード -->
<input type="date" id="noteDate" onchange="selectNoteDate(this.value); updateMonthlyMemoDisplay();">
```

`selectNoteDate()` は内部で以下を実行:
- `#currentWeekStart` を選択日付の週に更新
- `updateWeeklyPreview()` で週間プレビュー再描画
- `loadNoteForDate()` でノート読み込み

**教訓**: 複数UIの連動は、統合的なメソッドを用意して一箇所で制御

---

### 週間プレビューがスクロール表示（2025-11-27）

**症状**: 週間プレビューが縦スクロールになり7日分が見づらい

**原因**: `.weekly-preview` に `max-height: 500px` が設定されていた

**修正**: 3_notes.css に以下を追加
```css
.weekly-preview {
    max-height: none;
    height: auto;
}

#weekDays {
    overflow: visible;
    height: auto;
    max-height: none;
}
```

---

### 折りたたみアイコン切替不具合（2025-11-27）

**症状**: 月メモの▲/▼が切り替わらない（常に▲のまま）

**原因**: CSSの `transform: rotate(180deg)` とJSのアイコン変更が競合

**修正**: 3_notes.css の該当CSSを削除（JSで直接制御に統一）
```css
/* 削除したコード */
.monthly-memo-section.collapsed .collapse-icon {
    transform: rotate(180deg);
}
```

**教訓**: アイコン変更はCSSかJSのどちらか一方に統一

---

### 日付変更時に月メモが更新されない（2025-11-27）

**症状**: ◀▶ボタンや「今日」ボタンで日付変更しても月メモが古い月のまま

**原因**: `setToday()` と `changeDate()` で `updateMonthlyMemoDisplay()` と `selectNoteDate()` が呼ばれていなかった

**修正**: 両メソッドに追加
```javascript
setToday() {
    const today = new Date();
    document.getElementById('noteDate').value = formatDateForInput(today);
    this.loadNoteForDate(formatDateForInput(today));
    this.updateMonthlyMemoDisplay();      // ← 追加
    this.selectNoteDate(formatDateForInput(today));  // ← 追加
}

changeDate(days) {
    // ... 日付計算 ...
    this.loadNoteForDate(formatDateForInput(currentDate));
    this.updateMonthlyMemoDisplay();      // ← 追加
    this.selectNoteDate(formatDateForInput(currentDate));  // ← 追加
}
```

---

### トレードIDログ表示（2025-11-14）

**問題**: コンソールに「トレード保存完了: null」  
**原因**: TradeEntry.js 59行目で`tradeData`（ID無）を参照  
**修正**: `savedTrade`（ID付）に変更

### 円建て損益150円ズレ（2025-11-10）

**原因**: データ構造の二重管理（トップレベル vs yenProfitLoss）  
**修正**: 全表示層で`trade.yenProfitLoss.*`を参照に統一  
**ファイル**: YenProfitLossModalModule.js, TradeDetail.js, TradeList.js

### タブ間数字不一致（2025-11-21）

**原因**: 未決済トレードが計算に含まれていた  
**修正**: 決済済みチェック追加
```javascript
if (!trade.exits || trade.exits.length === 0) return false;
```
**ファイル**: SummaryCalculatorModule.js, StatisticsModule.js

### 決済編集モーダル改善（2025-11-10）

**問題**: エントリー価格確認のためモーダルを閉じる必要  
**修正**: TradeEdit.js `editExitInfo()` に参考情報セクション追加

---

### 分析タブと記録タブでpipsが10倍違う（2025-11-28）

**症状**: トレード記録タブでは正しいpips（例: 2.3）が表示されるが、分析タブでは10倍（例: 23）になる

**原因**: StatisticsModule.js の `#calculateTradePips()` が `trade.pips`（保存値）を優先使用。既存データの `trade.pips` が10倍だった。

**pips計算を行うファイル**:

| ファイル | 行番号 | 用途 |
|---------|--------|------|
| TradeCalculator.js | 22行目 | 基本計算 |
| TradeExit.js | 202-203行目 | 決済時のexits.pips |
| TradeEdit.js | 1239行目 | 編集時のexits.pips |
| bridge.js | 153行目 | RR計算表示 |
| script.js | 2245-2246行目 | 一括詳細保存時 |

**乗数**: JPY絡み=100、JPY以外=10000

**対処**: 既存データを1/10に修正するスクリプト実行

**教訓**: 
- `trade.pips` と `calculateTradePips()` の二重管理に注意
- 分析系モジュールが保存値を優先する場合、データの整合性が重要

---

### 一括入力の円建て損益表示バグ（2025-11-28）※機能削除により解消

**症状**: 一括入力で保存したトレードの円建て損益セクションが全て0円表示

**原因**: `#createTradeData`で`yenProfitLoss`オブジェクトが設定されていなかった

**対応**: 2025-11-29に一括入力機能自体を削除したため、この問題は解消

---

### 画像追加モーダル：クリック失敗（2025-12-11）

**症状**: 「PCに保存」ボタンをクリックしても反応しないことがある

**原因**: 
- onclick属性の限界（イベント伝播問題）
- z-index競合（tradeDetailModalと同じ1000）

**修正**:
- onclick → addEventListener に移行
- imageAddModal z-index: 1001に変更
- ImageAddModalModule.jsとして独立モジュール化

**教訓**: 複雑なモーダルはonclick属性を使わず、z-indexで明示的に管理

---

### 画像処理統一：5つの問題修正（2025-12-11）

**修正1: 詳細モーダルで画像が保存されない**  
原因: `showImageUploadOptions`がtradeIdを渡さない  
修正: `changeTradeImage`内で`ImageAddModalModule.open`を直接呼ぶ

**修正2: 相場ノート画像枠が表示されない**  
原因: `restoreNoteImages`が枠なし時に何もしない  
修正: 枠なし時に空枠3つを作成

**修正3: 相場ノート画像選択後に表示されない**  
原因: `handleProcessedImage`にnoteImage分岐なし  
修正: `pendingImageType === 'noteImage'`の分岐を追加

**修正4: 編集モードで画像枠が消える**  
原因: `editNote`で枠をクリアしてから`displayNoteImage`  
修正: `restoreNoteImages`を使用（枠再作成→画像表示）

**修正5: リロード時に確認ダイアログ**  
原因: `removeNoteImageAt`が常に`confirm`実行  
修正: `skipConfirm`引数を追加

**教訓**: 画像処理は統一ルール（3枠横並び）を徹底、内部呼び出しとUI操作を分離

---

### 画像追加モーダル：URL追加後にモーダルが閉じない（2025-12-11）

**原因**: `#handleUrlAdd()` に `this.close()` が抜けていた

**修正**: `handleProcessedImage(url)` の直後に `this.close()` を追加

---

## 10. 機能削除時のチェックリスト（2025-11-29追加）

機能を完全削除する際の確認項目：

### 1. コード検索

```bash
# 関連キーワードで全ファイル検索
grep -rn "機能名" *.js
grep -rn "関連フラグ" *.js
```

### 2. 削除対象の特定

| カテゴリ | 確認項目 |
|---------|---------|
| ファイル | モジュールファイル本体 |
| scriptタグ | index.htmlの読み込み |
| グローバル関数 | window.xxx登録 |
| EventBusリスナー | xxx.on('event', ...) |
| EventBus発火 | xxx.emit('event') |
| 判定フラグ | isXxx, hasXxx |
| データ | localStorage内の該当データ |
| HTML/UI | 関連するDOM要素 |

### 3. 影響範囲確認

```javascript
// デバッグコードで確認
(function() {
    // 削除対象が存在しないこと
    console.log('削除対象:', typeof window.削除対象);
    
    // 残すべき機能が存在すること
    console.log('残す機能:', typeof window.残す機能);
})();
```

### 4. 段階的削除

1. データ削除（バックアップ必須）
2. ファイル削除
3. 参照コード削除（各ファイル）
4. 動作確認
5. ドキュメント更新

# トレード分析強化 - 要件定義書 & ロードマップ v1.8

**作成日**: 2026-01-16  
**更新日**: 2026-01-29  
**ステータス**: 🚧 実装中（Phase 1-2完了）  
**優先度**: 🔴 CRITICAL（差別化機能）  
**コンセプト**: 「記録するだけ」→「成長できるシステム」  
**準拠**: MODULES.md標準パターン

---

## 📋 目次

1. [概要](#概要)
2. [機能1: 許容損失管理](#機能1-許容損失管理)
3. [機能2: 手法管理](#機能2-手法管理)
4. [機能3: 振り返り強化](#機能3-振り返り強化)
5. [機能4: トレード一覧バッジ](#機能4-トレード一覧バッジ)
6. [機能5: 月次レポート再編成](#機能5-月次レポート再編成)
7. [実装ロードマップ](#実装ロードマップ)
8. [更新履歴](#更新履歴)

---

## 概要

### 背景・課題

```
【現在のTrading Complete】
記録 → 統計表示

【課題】
- 許容損失を知らない初心者がそのまま使う
- 何を記録すれば「成長」につながるかわからない
- データはあるが「気づき」につながらない
- 「ルールを守れたか」が可視化されていない


【目指す姿】
記録 → 自動分析 → 気づき → 成長

「このシステムを使えば成長できる」
```

### 核心の考え方

> **「感情でトレードするものではない」**
> **「ルールを守れているかを重視」**

感情の記録ではなく、**ルール遵守**と**リスク管理**にフォーカス。

### 実装する機能

| 機能 | 目的 | 効果 | 状態 |
|------|------|------|------|
| 許容損失管理 | リスク管理の習慣化 | 資金を守る | ✅ 完了 |
| 手法管理 | 手法別の成績分析 | 得意・不得意の把握 | ✅ 完了 |
| 振り返り強化 | ルール遵守の可視化 | 規律あるトレード | ⬜ 未着手 |
| バッジ表示 | 一覧での即時把握 | 傾向の気づき | ⬜ 未着手 |
| レポート再編成 | 本当に欲しい情報 | **これぞレポート** | ⬜ 未着手 |

---

## 機能1: 許容損失管理 ✅ 完了

### 1.1 実装済み（Phase 1-2）

✅ 設定画面（設定 → トレーディング）
- 許容損失額の入力・保存
- SettingsModule API: `getRiskTolerance()`, `setRiskTolerance(amount)`
- EventBus: `settings:riskToleranceUpdated`

✅ 新規エントリー画面
- リスク管理セクション表示
- 損切り幅（pips）自動計算
- 決済通貨レート入力（クロス円は自動1.00）
- 適正ロット自動計算
- ロット警告色表示（適正/オレンジ/赤）

✅ トレードデータに保存されるフィールド
```javascript
{
  riskTolerance: 5000,        // エントリー時点の許容損失設定
  stopLossPips: 50,           // 損切り幅（pips）
  quoteCurrencyRate: 1.00,    // 決済通貨レート
  calculatedLot: 1.0,         // 計算された適正ロット
  lotSize: 1.0,               // 実際のロット
  isOverRisk: false,          // 許容損失超過フラグ
  riskStatus: 'normal'        // 'normal' / 'warning' / 'danger'
}
```

✅ Supabase連携
- tradesテーブル: 7カラム追加済み
- user_settingsテーブル: risk_tolerance カラム追加済み

---

## 機能2: 手法管理 ✅ 完了

### 2.1 実装済み（Phase 1-2）

✅ 設定画面（設定 → トレーディング）
- 手法の追加・削除（論理削除）
- SettingsModule API: `getAllMethods()`, `addMethod()`, `deleteMethod()`, `getMethodById()`
- EventBus: `settings:methodAdded`, `settings:methodDeleted`

✅ 新規エントリー画面
- 手法選択プルダウン
- 選択した手法IDがトレードデータに保存

✅ Supabase連携
- tradesテーブル: method_id カラム追加済み
- user_settingsテーブル: methods カラム追加済み
- SyncModule: EventBusリスナーで自動同期

### 2.2 手法データ構造

```javascript
{
  id: 'mtd_' + timestamp,
  name: '手法名',           // 最大30文字
  shortName: '略称',        // 最大10文字（バッジ表示用）
  memo: 'メモ',             // 最大200文字
  order: 1,
  createdAt: ISO string,
  deletedAt: null           // 論理削除時にISO stringが入る
}
```

---

## 機能3: 振り返り強化

### 3.1 目的

```
「決済後に振り返る習慣」を作る
→ ルールを守れたか？
→ 決済後にトレンドは続いたか？
→ 次に活かせる気づきは？
```

### 3.2 決済画面への追加項目

```
┌─────────────────────────────────────────────────────┐
│ 📊 振り返り（決済後に記入）                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│ ルールを守れましたか？                               │
│ ○ はい  ○ いいえ  ○ 一部守れなかった               │
│                                                     │
│ 決済後、トレンドは続きましたか？                     │
│ ○ 続いた（利確が早かった）                          │
│ ○ 終わった（良い判断だった）                        │
│ ○ 未確認                                           │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3.3 保存されるフィールド

```javascript
{
  reflection: {
    ruleFollowed: 'yes' | 'no' | 'partial',  // ルール遵守
    trendContinued: 'yes' | 'no' | 'unknown', // トレンド継続
    updatedAt: ISO string
  }
}
```

### 3.4 未実装（Phase 3）

⬜ 決済画面にルール遵守フラグ追加
⬜ トレンド継続フラグ追加
⬜ 振り返りデータ保存
⬜ Supabase連携

---

## 機能4: トレード一覧バッジ

### 4.1 未実装（Phase 4）

⬜ 手法バッジ表示（略称）
⬜ 許容損失バッジ（✅/⚠️/🚨）
⬜ ルール遵守バッジ
⬜ バッジ用CSS
⬜ 手法フィルター

### 4.2 実装済み関連機能

✅ ブローカーバッジ表示設定（ON/OFF切り替え可能）

---

## 機能5: 月次レポート再編成

### 5.1 未実装（Phase 5）

⬜ ルール遵守セクション
⬜ リスク管理セクション（許容損失内/超過の比較）
⬜ 手法別成績セクション
⬜ 決済判断振り返りセクション

---

## 実装ロードマップ

### 全体進捗

| Phase | 内容 | 状態 | 完了日 |
|-------|------|------|--------|
| Phase 1 | 設定機能 | ✅ 完了 | 2026-01-29 |
| Phase 2 | エントリー画面 | ✅ 完了 | 2026-01-29 |
| Phase 3 | 決済・振り返り | ⬜ 未着手 | - |
| Phase 4 | 一覧・分析 | ⬜ 未着手 | - |
| Phase 5 | 月次レポート | ⬜ 未着手 | - |
| Phase 6 | AI参照用サマリー基盤 | ⬜ 未着手 | - |

**進捗率**: 49% (18/37タスク)

---

### Phase 1: 設定機能（10タスク）✅ 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 1 | ✅ getRiskTolerance() API追加 | SettingsModule.js | 完了 |
| 2 | ✅ setRiskTolerance(amount) API追加 | SettingsModule.js | 完了 |
| 3 | ✅ EventBus 'settings:riskToleranceUpdated' 追加 | SettingsModule.js | 完了 |
| 4 | ✅ 許容損失UI HTML追加 | index.html | 完了 |
| 5 | ✅ 許容損失UI JavaScript追加 | js/part5/risk-ui.js | 完了 |
| 6 | ✅ getAllMethods() API追加 | SettingsModule.js | 完了 |
| 7 | ✅ addMethod(name, shortName, memo) API追加 | SettingsModule.js | 完了 |
| 8 | ✅ deleteMethod(id) API追加（論理削除） | SettingsModule.js | 完了 |
| 9 | ✅ 手法管理UI HTML追加 | index.html | 完了 |
| 10 | ✅ 手法管理UI JavaScript追加 | js/part5/method-ui.js | 完了 |

**Phase 1 進捗**: 10/10 ✅

---

### Phase 2: エントリー画面（8タスク）✅ 完了

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 11 | ✅ リスク管理セクションHTML追加 | index.html | 完了 |
| 12 | ✅ 損切り幅(pips)自動計算 | risk-ui.js | 完了 |
| 13 | ✅ 決済通貨レート入力欄追加 | index.html, risk-ui.js | 完了 |
| 14 | ✅ 適正ロット自動計算ロジック | risk-ui.js | 完了 |
| 15 | ✅ 警告色表示（白/オレンジ/赤） | risk-ui.js | 完了 |
| 16 | ✅ トレード保存時にリスク情報追加 | TradeEntry.js | 完了 |
| 17 | ✅ 手法選択プルダウンHTML追加 | index.html | 完了 |
| 18 | ✅ 手法選択ロジック・保存 | TradeEntry.js | 完了 |

**Phase 2 進捗**: 8/8 ✅

#### Phase 2 追加修正（実装時に発生）

| 修正 | ファイル | 内容 |
|------|----------|------|
| ✅ | bridge.js | MODULES.md準拠化（formData作成をTradeEntryに委譲） |
| ✅ | TradeEntry.js | direction取得をselectボックスに修正 |
| ✅ | TradeEntry.js | 画像一時データ(tempChartImage)のクリア追加 |
| ✅ | entry-form-enhancement.js | 通貨ペア選択時にonPairChanged呼び出し追加 |
| ✅ | index.html | EventBus読み込み順序修正（SyncModuleより前に移動） |
| ✅ | SyncModule.js | EventBusリスナー追加（methodAdded, methodDeleted, riskToleranceUpdated, showBrokerBadgeUpdated） |
| ✅ | SyncModule.js | methods, risk_tolerance, show_broker_badge の同期追加 |
| ✅ | Supabase trades | 7カラム追加（method_id, risk_tolerance, stop_loss_pips, quote_currency_rate, calculated_lot, risk_status, is_over_risk） |
| ✅ | Supabase user_settings | 3カラム追加（methods, risk_tolerance, show_broker_badge） |

---

### Phase 3: 決済・振り返り（4タスク）⬜ 未着手

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 19 | ⬜ 振り返りセクションHTML追加 | index.html | 未着手 |
| 20 | ⬜ ルール遵守フラグ(YES/NO/PARTIAL)追加 | TradeExit.js | 未着手 |
| 21 | ⬜ トレンド継続フラグ追加 | TradeExit.js | 未着手 |
| 22 | ⬜ 振り返りデータ保存 | TradeExit.js | 未着手 |

**Phase 3 進捗**: 0/4

---

### Phase 4: 一覧・分析（6タスク）⬜ 未着手

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 23 | ⬜ 手法バッジ表示（略称） | TradeList.js | 未着手 |
| 24 | ⬜ 許容損失バッジ表示 | TradeList.js | 未着手 |
| 25 | ⬜ ルール遵守バッジ表示 | TradeList.js | 未着手 |
| 26 | ⬜ バッジ用CSS追加 | 4_features.css | 未着手 |
| 27 | ⬜ 手法フィルター追加 | TradeList.js | 未着手 |
| 28 | ⬜ 統計計算に新項目追加 | StatisticsModule.js | 未着手 |

**Phase 4 進捗**: 0/6

---

### Phase 5: 月次レポート再編成（4タスク）⬜ 未着手

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 29 | ⬜ ルール遵守セクション追加 | ReportModule.js | 未着手 |
| 30 | ⬜ リスク管理セクション追加 | ReportModule.js | 未着手 |
| 31 | ⬜ 手法別成績セクション追加 | ReportModule.js | 未着手 |
| 32 | ⬜ 決済判断振り返りセクション追加 | ReportModule.js | 未着手 |

**Phase 5 進捗**: 0/4

---

### Phase 6: AI参照用サマリー基盤（5タスク）⬜ 未着手

| # | タスク | ファイル | 状態 |
|---|--------|----------|------|
| 33 | ⬜ AISummaryModule クラス作成 | js/modules/AISummaryModule.js | 未着手 |
| 34 | ⬜ #calculateBasicStats() 実装 | AISummaryModule.js | 未着手 |
| 35 | ⬜ #calculateRuleCompliance() 実装 | AISummaryModule.js | 未着手 |
| 36 | ⬜ #calculateRiskManagement() 実装 | AISummaryModule.js | 未着手 |
| 37 | ⬜ #calculateMethodStats() 実装 | AISummaryModule.js | 未着手 |

**Phase 6 進捗**: 0/5

---

## 更新履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| v1.0 | 2026-01-16 | 初版作成 |
| v1.1 | 2026-01-16 | 感情管理削除、為替レート入力追加、バッジ追加、レポート再編成追加 |
| v1.2 | 2026-01-16 | 警告閾値を2倍に変更、設計思想・AI布石を追記 |
| v1.3 | 2026-01-16 | 手法管理：編集不可・略称追加・削除時の挙動明確化 |
| v1.4 | 2026-01-16 | AI参照設計セクション追加、Phase 6追加、37タスクに拡張 |
| v1.5 | 2026-01-16 | MODULES.md準拠に修正 |
| v1.6 | 2026-01-28 | タスク番号修正（35→37） |
| v1.7 | 2026-01-29 | Phase 1-2完了（18/37タスク、49%）、実装時の追加修正記録 |
| **v1.8** | **2026-01-29** | **Supabase連携完了（trades 7カラム、user_settings 3カラム追加）、EventBus初期化順序修正、Phase 2追加修正9件記録** |

---

*このドキュメントは開発時の指針です。最新の技術仕様はMODULES.mdを参照してください。*

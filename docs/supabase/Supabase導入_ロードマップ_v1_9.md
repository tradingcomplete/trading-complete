# Supabase導入 ロードマップ・要件定義書 v1.9

**作成日**: 2025-12-17  
**更新日**: 2026-01-04  
**プロジェクト**: Trading Complete  
**目的**: ログイン機能・クラウドデータ同期の実装

---

## ⚠️ 重要原則: MODULES.md準拠

**すべての実装はMODULES.mdに沿って行うこと**

| 原則 | 説明 |
|------|------|
| モジュールパターン | クラス形式、プライベートフィールド(#)、EventBus統合 |
| 責任の集約 | 認証→AuthModule、設定→SettingsModule、同期→SyncModule |
| グローバル関数 | モジュールメソッドへの橋渡しのみ（ロジックは書かない） |
| UI/ロジック分離 | HTMLはUIのみ、ロジックはモジュール内 |

---

## 🔐 重要原則: セキュリティ

**金融データを扱うシステムとして、セキュリティを最優先する**

| 原則 | 説明 |
|------|------|
| 最小権限 | ユーザーは自分のデータのみアクセス可能（RLS） |
| 入力値検証 | すべての入力をサニタイズ・検証 |
| セキュアエラー | 攻撃者にヒントを与えない |
| セッション管理 | 24時間で自動ログアウト |

**詳細**: Trading_Complete_セキュリティ要件定義書_v1_4.md

---

## 🌐 ドメイン構成（確定）

| URL | 用途 | ホスティング | 状態 |
|-----|------|-------------|------|
| tradingcomplete.com | ランディングページ（製品紹介・LINE登録） | 現状維持 | ✅ 稼働中 |
| app.tradingcomplete.com | アプリ本体（トレード記録システム） | GitHub Pages | 🔜 リリース時 |

---

## 📋 目次

1. [現状分析](#1-現状分析)
2. [導入目標](#2-導入目標)
3. [全体スケジュール](#3-全体スケジュール)
4. [Phase 1-3.6](#phase-1-36) ✅ 完了
5. [Phase 4: データ同期実装](#phase-4-データ同期実装) 🔄 進行中
6. [Phase 5: 統合テスト・本番準備・リリース](#phase-5-統合テスト本番準備リリース)

---

## 1. 現状分析

### 1.1 システム概要

| 項目 | 現状 |
|------|------|
| アプリ完成度 | 95-97%（ローカル版） |
| コード規模 | 約50,000行（HTML/CSS/JavaScript） |
| データ保存 | localStorage + Supabase同期 |
| 画像保存 | **Supabase Storage** 🆕 |
| ホスティング | GitHub Pages |

### 1.2 既存データ構造（localStorage）

| キー | 内容 | 移行対象 | 同期状態 |
|------|------|---------|----------|
| `trades` | トレード記録 | ✅ 必須 | ✅ 完了 |
| `notes` | 相場ノート | ✅ 必須 | ✅ 完了 |
| `expenses` | 経費データ | ✅ 必須 | ✅ 完了 |
| `depositWithdrawals` | 入出金記録 | ✅ 必須 | ✅ 完了 |
| `tc_closed_periods` | 締め期間 | ✅ 必須 | ✅ 完了 |
| `brokers` | ブローカー設定 | ✅ 必須 | ✅ 完了 |
| `favoritePairs` | お気に入り通貨ペア | ✅ 必須 | ✅ 完了 |
| `monthlyMemos` | 月メモ | ✅ 必須 | ✅ 完了 |
| **画像（chartImages）** | **トレード画像** | **✅ 必須** | **✅ Storage対応** 🆕 |

---

## 2. 導入目標

### 2.1 必須要件（Must Have）

| 要件 | 説明 | 状態 |
|------|------|------|
| ユーザー認証 | メール/パスワードでログイン | ✅ 完了 |
| アクセス制御 | 未ログインユーザーはアプリ使用不可 | ✅ 完了 |
| セキュリティ基盤 | XSS対策、入力検証、セッション管理 | ✅ 完了 |
| データ同期 | localStorage ↔ Supabase 双方向同期 | ✅ 完了 |
| データ分離 | ユーザーごとにデータを分離（RLS） | ✅ 完了 |
| マイページ | アカウント情報管理・ログアウト | ✅ 完了 |
| **画像ストレージ** | **Supabase Storageで画像保存** | **✅ 基本実装完了** 🆕 |

---

## 3. 全体スケジュール

### 3.1 フェーズ一覧

| Phase | 内容 | 工数目安 | 状態 |
|-------|------|---------|------|
| **Phase 1** | 準備・環境構築 | 1日 | ✅ **完了** |
| **Phase 2** | データベース設計 | 2-3日 | ✅ **完了** |
| **Phase 3** | 認証実装 | 4-5日 | ✅ **完了** |
| **Phase 3.5** | マイページUI作成 | 1-2日 | ✅ **完了** |
| **Phase 3.6** | セキュリティ基盤 | 1-2日 | ✅ **完了** |
| **Phase 4** | データ同期実装 | 5-7日 | 🔄 **90%完了** |
| **Phase 5** | 統合テスト・本番準備 | 3-4日 | ⬜ 未着手 |

---

## Phase 1-3.6 ✅ 完了

（詳細は前バージョン参照）

- Phase 1 完了: 2025-12-17
- Phase 2 完了: 2025-12-17
- Phase 3 完了: 2025-12-18
- Phase 3.5 完了: 2025-12-19
- Phase 3.6 完了: 2025-12-30

---

## Phase 4: データ同期実装 🔄 進行中

### 4.1 SyncModule作成 ✅ 完了

（詳細は前バージョン参照）

### 4.2 TradeManager統合 ✅ 完了

（詳細は前バージョン参照）

### 4.3 他モジュール対応 ✅ 完了

| テーブル | モジュール | 状態 | 完了日 |
|---------|-----------|------|--------|
| trades | TradeManager | ✅ | 2025-12-30 |
| notes | NoteManagerModule | ✅ | 2026-01-03 |
| expenses | ExpenseManagerModule | ✅ | 2026-01-04 |
| capital_records | CapitalManagerModule | ✅ | 2026-01-04 |
| user_settings | SettingsModule | ✅ | 2026-01-04 |

### 4.4 マイページ変更機能 ⬜ 未着手

| Step | タスク | 状態 |
|------|--------|------|
| 4.4.1 | ユーザーネーム変更機能 | ⬜ |
| 4.4.2 | メールアドレス変更機能 | ⬜ |
| 4.4.3 | パスワード変更機能 | ⬜ |

### 4.5 Supabase Storage（画像保存）🆕 🔄 進行中

| Step | タスク | 状態 | 完了日 |
|------|--------|------|--------|
| 4.5.1 | バケット `trade-images` 作成 | ✅ | 2026-01-04 |
| 4.5.2 | RLSポリシー設定 | ✅ | 2026-01-04 |
| 4.5.3 | ImageHandler.uploadToCloud() 実装 | ✅ | 2026-01-04 |
| 4.5.4 | SyncModule画像アップロード対応 | ✅ | 2026-01-04 |
| 4.5.5 | トレード保存時のURL変換 | ✅ | 2026-01-04 |
| 4.5.6 | **画像表示対応（URL→img）** | ⬜ | - |
| 4.5.7 | ノート画像保存時のURL変換 | ⬜ | - |
| 4.5.8 | 既存Base64画像の移行処理 | ⬜ | - |

**Supabase Storage設計**:

```
バケット名: trade-images
├── {user_id}/
│   ├── trades/
│   │   └── {trade_id}/
│   │       ├── chart1.jpg
│   │       ├── chart2.jpg
│   │       └── chart3.jpg
│   └── notes/
│       └── {date}/
│           └── image1.jpg
```

**容量比較**:

| 保存先 | 無料枠 | 画像枚数目安 |
|--------|--------|-------------|
| localStorage | 5MB | 約25枚 |
| Supabase Database（Base64） | 500MB | 約2,500枚 |
| **Supabase Storage** | **1GB** | **約5,000枚** ✅ |

**データ形式の変化**:

```javascript
// 変換前（localStorage）
{ type: 'chart1', data: 'data:image/jpeg;base64,...', timestamp: '...' }

// 変換後（Supabase）
{ type: 'chart1', url: 'https://xxx.supabase.co/storage/...', path: 'userId/trades/.../chart1.jpg', timestamp: '...' }
```

### 4.6 SyncModule バージョン履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| v1.0.1 | 2025-12-30 | trades同期実装 |
| v1.1.0 | 2026-01-03 | notes同期追加 |
| v1.1.1 | 2026-01-03 | notes変換処理修正 |
| v1.2.0 | 2026-01-04 | expenses同期追加 |
| v1.3.0 | 2026-01-04 | capital_records同期追加 |
| v1.4.0 | 2026-01-04 | user_settings同期追加 |
| **v1.5.0** | **2026-01-04** | **画像アップロード統合（Supabase Storage）** 🆕 |

### 4.7 ImageHandler バージョン履歴 🆕

| バージョン | 日付 | 内容 |
|-----------|------|------|
| v1.0.0 | - | 初版（ローカル処理のみ） |
| **v1.1.0** | **2026-01-04** | **Supabase Storage対応追加** |

**追加メソッド**:
- `uploadToCloud(source, options)` - Storageにアップロード
- `getSignedUrl(path)` - 署名付きURL取得（1時間有効）
- `deleteFromCloud(path)` - 画像削除
- `base64ToBlob(base64)` - Base64→Blob変換

### 4.8 成果物

```
js/sync/SyncModule.js（v1.5.0）✅
js/handlers/imageHandler.js（v1.1.0）✅ 🆕
js/part2/TradeManager-nomodule.js ✅
js/part3_modules/NoteManagerModule.js ✅
js/part7_modules/ExpenseManagerModule.js ✅
js/part7_modules/CapitalManagerModule.js ✅
js/part5_modules/SettingsModule.js ✅
js/part7_modules/ClosingManagerModule.js ✅
```

### 4.9 完了条件

- [x] 新規トレード追加 → Supabaseに保存される
- [x] 新規ノート追加 → Supabaseに保存される
- [x] 新規経費追加 → Supabaseに保存される
- [x] 新規入出金追加 → Supabaseに保存される
- [x] 設定変更 → Supabaseに保存される
- [x] **画像がSupabase Storageにアップロードされる** 🆕
- [x] **chart_imagesにURLが保存される** 🆕
- [ ] 画像表示がURL形式に対応する
- [ ] ノート画像がSupabase Storageに保存される
- [ ] 既存Base64画像が移行される
- [ ] ユーザーネーム変更が動作する
- [ ] メールアドレス変更が動作する
- [ ] パスワード変更が動作する

---

## Phase 5: 統合テスト・本番準備・リリース

### 5.1 機能テスト

| # | シナリオ | 状態 |
|---|---------|------|
| 1 | 新規ユーザー登録 → メール確認 → ログイン | ⬜ |
| 2 | トレード追加 → 別端末で確認 | ⬜ |
| 3 | トレード編集 → 同期確認 | ⬜ |
| 4 | トレード削除 → 同期確認 | ⬜ |
| 5 | 相場ノート追加 → 同期確認 | ⬜ |
| 6 | 経費追加 → 同期確認 | ⬜ |
| 7 | 入出金追加 → 同期確認 | ⬜ |
| 8 | 設定変更 → 同期確認 | ⬜ |
| 9 | ログアウト → 再ログイン → データ確認 | ⬜ |
| 10 | 既存データ移行 → 確認 | ⬜ |
| 11 | マイページ → ユーザー情報表示確認 | ⬜ |
| 12 | マイページ → 各種変更機能確認 | ⬜ |
| 13 | **画像アップロード → Storage確認** | ✅ 🆕 |
| 14 | **画像表示 → URL形式対応確認** | ⬜ |

---

## ファイル構成

### 新規作成ファイル

```
js/
├── core/
│   ├── supabaseClient.js    ← ✅ Phase 1 完了
│   └── security.js          ← ✅ Phase 3.6 完了
├── auth/
│   └── AuthModule.js        ← ✅ Phase 3 完了（v1.1.0）
├── sync/
│   └── SyncModule.js        ← ✅ Phase 4 完了（v1.5.0）🆕
└── handlers/
    └── imageHandler.js      ← ✅ Phase 4.5 完了（v1.1.0）🆕
```

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Supabase無料枠超過 | 中 | 使用量モニタリング、アラート設定 |
| 同期競合（複数端末） | 中 | 最終更新優先（Last Write Wins） |
| 移行時データ損失 | 高 | 移行前バックアップ、確認ダイアログ |
| 認証トークン漏洩 | 高 | anon keyのみ使用、RLS徹底 |
| XSS攻撃 | 高 | **security.jsでサニタイズ** |
| セッションハイジャック | 中 | **24時間タイムアウト** |
| localStorageデータ破損 | 中 | **StorageValidatorで検証** |
| **画像容量不足** | **高** | **✅ Supabase Storage実装完了** 🆕 |
| **署名付きURL期限切れ** | **低** | **表示時に再取得（後で実装）** 🆕 |

---

## 📊 進捗サマリー

```
Phase 1   ██████████ 100% ✅ 完了（2025-12-17）
Phase 2   ██████████ 100% ✅ 完了（2025-12-17）
Phase 3   ██████████ 100% ✅ 完了（2025-12-18）
Phase 3.5 ██████████ 100% ✅ 完了（2025-12-19）
Phase 3.6 ██████████ 100% ✅ 完了（2025-12-30）
Phase 4   █████████░  90% 🔄 進行中（Storage基本実装完了）
Phase 5   ░░░░░░░░░░   0%
```

**次のアクション**: 
1. 画像表示対応（URL→img src）
2. ノート画像のStorage対応
3. 既存Base64画像の移行ツール

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-12-17 | 初版作成 |
| v1.1 | 2025-12-17 | Phase 5に「本番環境準備確認」セクション追加 |
| v1.2 | 2025-12-17 | Phase 1 完了を反映 |
| v1.3 | 2025-12-18 | Phase 2, Phase 3 完了を反映 |
| v1.4 | 2025-12-18 | Phase 3.5（マイページUI）追加、favicon完了 |
| v1.5 | 2025-12-19 | Phase 3.5完了、MODULES.md準拠の原則追加 |
| v1.6 | 2025-12-19 | Phase 3.6（セキュリティ基盤）追加 |
| v1.7 | 2025-12-29 | ドメイン構成セクション追加、StorageValidator追加 |
| v1.7.1 | 2025-12-30 | Phase 3.6 完了 |
| v1.8 | 2026-01-04 | Phase 4.1〜4.3 完了、SyncModule v1.4.0 |
| **v1.9** | **2026-01-04** | **Phase 4.5 Storage基本実装完了、SyncModule v1.5.0、ImageHandler v1.1.0** |

---

*このドキュメントは実装の進捗に合わせて更新してください。*

# Trading Complete ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶å®šç¾©æ›¸ v1.4

**ä½œæˆæ—¥**: 2025-12-19  
**æ›´æ–°æ—¥**: 2026-01-14  
**å¯¾è±¡**: Trading Completeï¼ˆé‡‘èç³»ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ ï¼‰  
**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡‘èãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ä¿è­·ã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡](#1-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡)
2. [ç¾çŠ¶åˆ†æ](#2-ç¾çŠ¶åˆ†æ)
3. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ä¸€è¦§](#3-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ä¸€è¦§)
4. [èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†](#4-èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†)
5. [ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡](#5-ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)
6. [å…¥åŠ›å€¤æ¤œè¨¼ãƒ»XSSå¯¾ç­–](#6-å…¥åŠ›å€¤æ¤œè¨¼xsså¯¾ç­–)
7. [localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼](#7-localstorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼)
8. [Supabase Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#8-supabase-storage-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
9. [é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#9-é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
10. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#10-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
11. [ç›£æŸ»ãƒ»ãƒ­ã‚°](#11-ç›£æŸ»ãƒ­ã‚°)
12. [å°†æ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µ](#12-å°†æ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µ)
13. [å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#13-å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
14. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆé …ç›®](#14-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆé …ç›®)
15. [å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#15-å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)

---

## 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡

### åŸºæœ¬åŸå‰‡

| åŸå‰‡ | èª¬æ˜ |
|------|------|
| **æœ€å°æ¨©é™** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **å¤šå±¤é˜²å¾¡** | è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤ã§ä¿è­· |
| **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹’å¦** | æ˜ç¤ºçš„ã«è¨±å¯ã•ã‚Œãªã„é™ã‚Šã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ |
| **å®‰å…¨ãªå¤±æ•—** | ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã™ |

### é‡‘èãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã®ç‰¹åˆ¥ãªé…æ…®

```
Trading CompleteãŒæ‰±ã†ãƒ‡ãƒ¼ã‚¿:
â”œâ”€â”€ ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ï¼ˆæç›Šæƒ…å ±ï¼‰
â”œâ”€â”€ å…¥å‡ºé‡‘è¨˜éŒ²ï¼ˆå£åº§æ®‹é«˜ï¼‰
â”œâ”€â”€ çµŒè²»ãƒ‡ãƒ¼ã‚¿ï¼ˆç¢ºå®šç”³å‘Šé–¢é€£ï¼‰
â”œâ”€â”€ å€‹äººè¨­å®šï¼ˆãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼æƒ…å ±ï¼‰
â””â”€â”€ ãƒãƒ£ãƒ¼ãƒˆç”»åƒï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰åˆ†æï¼‰âœ…

â†’ ã™ã¹ã¦ã€Œå€‹äººã®é‡‘èæƒ…å ±ã€ã¨ã—ã¦å³é‡ã«ä¿è­·
```

---

## 2. ç¾çŠ¶åˆ†æ

### âœ… å®Ÿè£…æ¸ˆã¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆPhase 4ã¾ã§å®Œäº†ï¼‰

| é …ç›® | çŠ¶æ…‹ | å®Ÿè£…Phase | å®Œäº†æ—¥ |
|------|------|-----------|--------|
| HTTPSé€šä¿¡ | âœ… å®Œäº† | GitHub Pagesæ¨™æº– | - |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦æ¤œè¨¼ | âœ… å®Œäº† | Phase 3 | 2025-12-18 |
| ãƒ¡ãƒ¼ãƒ«ç¢ºèª | âœ… å®Œäº† | Phase 3 | 2025-12-18 |
| RLSï¼ˆè¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰ | âœ… å®Œäº† | Phase 2 | 2025-12-17 |
| anon keyã®ã¿ä½¿ç”¨ | âœ… å®Œäº† | Phase 1 | 2025-12-17 |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ24hï¼‰ | âœ… å®Œäº† | Phase 3.6 | 2025-12-30 |
| XSSå¯¾ç­–ï¼ˆSecurityUtilsï¼‰ | âœ… å®Œäº† | Phase 3.6 | 2025-12-30 |
| å…¥åŠ›å€¤ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆInputValidatorï¼‰ | âœ… å®Œäº† | Phase 3.6 | 2025-12-30 |
| localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆStorageValidatorï¼‰ | âœ… å®Œäº† | Phase 3.6 | 2025-12-30 |
| ã‚»ã‚­ãƒ¥ã‚¢ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆSecureErrorï¼‰ | âœ… å®Œäº† | Phase 3.6 | 2025-12-30 |
| ãƒ‡ãƒ¼ã‚¿åŒæœŸï¼ˆ5ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ | âœ… å®Œäº† | Phase 4.1-4.3 | 2026-01-04 |
| **Supabase Storage RLS** | **âœ… å®Œäº†** | **Phase 4.5** | **2026-01-05** |
| **å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨** | **âœ… å®Œäº†** | **Phase 4.8** | **2026-01-14** |
| **ãƒã‚¤ãƒšãƒ¼ã‚¸å¤‰æ›´æ©Ÿèƒ½** | **âœ… å®Œäº†** | **Phase 4.4** | **2026-01-14** |

### âš ï¸ æœªå®Ÿè£…ãƒ»è¦å¼·åŒ–ï¼ˆå°†æ¥ï¼‰

| é …ç›® | å„ªå…ˆåº¦ | å¯¾å¿œPhase |
|------|--------|-----------|
| CSRFãƒˆãƒ¼ã‚¯ãƒ³ | ä½ | Supabaseå¯¾å¿œæ¸ˆã¿ |
| 2æ®µéšèªè¨¼ | ä½ | å°†æ¥ |
| ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™ | ä½ | å°†æ¥ |

---

## 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ä¸€è¦§

### å¿…é ˆè¦ä»¶ï¼ˆMust Haveï¼‰- âœ… å…¨å®Œäº†

| ID | è¦ä»¶ | èª¬æ˜ | çŠ¶æ…‹ |
|----|------|------|------|
| SEC-001 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | 24æ™‚é–“ã§è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | âœ… å®Œäº† |
| SEC-002 | XSSå¯¾ç­– | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º | âœ… å®Œäº† |
| SEC-003 | å…¥åŠ›å€¤æ¤œè¨¼ | æ•°å€¤ãƒ»æ—¥ä»˜ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®æ¤œè¨¼ | âœ… å®Œäº† |
| SEC-004 | ã‚»ã‚­ãƒ¥ã‚¢ã‚¨ãƒ©ãƒ¼ | è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤º | âœ… å®Œäº† |
| SEC-005 | RLSç¢ºèª | å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSå‹•ä½œç¢ºèª | âœ… å®Œäº† |
| SEC-006 | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œå…¨æ€§ | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢ | âœ… å®Œäº† |
| SEC-007 | localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ | èª­ã¿è¾¼ã¿æ™‚ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼æ¤œè¨¼ | âœ… å®Œäº† |
| SEC-008 | Storage RLS | ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | âœ… å®Œäº† |
| **SEC-009** | **ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ‹ã‚¿ã‚¤ã‚º** | **å…¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®XSSå¯¾ç­–** | **âœ… å®Œäº†** |

### æ¨å¥¨è¦ä»¶ï¼ˆShould Haveï¼‰- ãƒªãƒªãƒ¼ã‚¹å¾Œ

| ID | è¦ä»¶ | èª¬æ˜ | çŠ¶æ…‹ |
|----|------|------|------|
| SEC-010 | ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™ | 5å›å¤±æ•—ã§15åˆ†ãƒ­ãƒƒã‚¯ | â¬œ |
| ~~SEC-011~~ | ~~ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ~~ | ~~ãƒ¡ãƒ¼ãƒ«çµŒç”±ã®ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½~~ | **âœ… å®Œäº†** |
| SEC-012 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | ä»–ç«¯æœ«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ | â¬œ |

### å°†æ¥è¦ä»¶ï¼ˆCould Haveï¼‰- v2.0ä»¥é™

| ID | è¦ä»¶ | èª¬æ˜ | çŠ¶æ…‹ |
|----|------|------|------|
| SEC-013 | 2æ®µéšèªè¨¼ | TOTPå¯¾å¿œ | â¬œ |
| SEC-014 | ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ | ä¸å¯©ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ | â¬œ |
| SEC-015 | ãƒ‡ãƒ¼ã‚¿æš—å·åŒ– | localStorageæš—å·åŒ– | â¬œ |
| SEC-016 | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæš—å·åŒ– | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | â¬œ |

---

## 4. èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### SEC-001: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ âœ… å®Ÿè£…å®Œäº†

**è¨­å®šå€¤**: 24æ™‚é–“ï¼ˆ86400ç§’ï¼‰

**å®Ÿè£…**: AuthModule.js v1.3.0

```javascript
// AuthModule.js - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–
#startSessionMonitor() {
    // 5åˆ†ã”ã¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
    this.#sessionCheckInterval = setInterval(() => {
        this.#checkSessionExpiry();
    }, 5 * 60 * 1000);
}

#checkSessionExpiry() {
    const session = this.#session;
    if (!session?.expires_at) return;
    
    const expiresAt = new Date(session.expires_at * 1000);
    const now = new Date();
    
    if (now >= expiresAt) {
        this.#showSessionExpiredModal();
    }
}
```

**UI**: ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œæ™‚ã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆindex.html #sessionExpiredModalï¼‰

### ãƒã‚¤ãƒšãƒ¼ã‚¸å¤‰æ›´æ©Ÿèƒ½ âœ… å®Ÿè£…å®Œäº†ï¼ˆv1.3.0ï¼‰

| æ©Ÿèƒ½ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|------|---------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ å¤‰æ›´ | `changeUsername()` | user_metadataã«ä¿å­˜ |
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ | `changeEmail()` | ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€emailRedirectToè¨­å®š |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ | `changePassword()` | validatePassword()ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |

**Supabaseè¨­å®š**:
- ã€ŒSecure email changeã€â†’ **ã‚ªãƒ•**ï¼ˆæ–°ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§å¤‰æ›´å¯èƒ½ï¼‰

---

## 5. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### SEC-005: RLSï¼ˆRow Level Securityï¼‰âœ… å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªæ¸ˆã¿

| ãƒ†ãƒ¼ãƒ–ãƒ« | ãƒãƒªã‚·ãƒ¼ | ç¢ºèªçŠ¶æ…‹ | åŒæœŸçŠ¶æ…‹ |
|---------|---------|---------|---------|
| trades | `auth.uid() = user_id` | âœ… | âœ… åŒæœŸå®Œäº† |
| notes | `auth.uid() = user_id` | âœ… | âœ… åŒæœŸå®Œäº† |
| expenses | `auth.uid() = user_id` | âœ… | âœ… åŒæœŸå®Œäº† |
| capital_records | `auth.uid() = user_id` | âœ… | âœ… åŒæœŸå®Œäº† |
| user_settings | `auth.uid() = user_id` | âœ… | âœ… åŒæœŸå®Œäº† |

---

## 6. å…¥åŠ›å€¤æ¤œè¨¼ãƒ»XSSå¯¾ç­–

### SEC-002: XSSå¯¾ç­– âœ… å®Ÿè£…å®Œäº†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `js/core/security.js`

```javascript
const SecurityUtils = {
    escapeHtml(text) {
        if (typeof text !== 'string') return text;
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, char => map[char]);
    },
    
    sanitizeNumber(value, defaultValue = 0) { ... },
    sanitizePositiveNumber(value, defaultValue = 0) { ... },
    sanitizeDate(value) { ... },
    sanitizePair(value) { ... },
    truncateText(text, maxLength = 1000) { ... },
    sanitizeUrl(url) { ... },
    sanitizeDirection(value) { ... }
};
```

### SEC-009: ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨ âœ… å®Ÿè£…å®Œäº†ï¼ˆPhase 4.8ï¼‰

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå¯¾è±¡ | æ–¹å¼ | çŠ¶æ…‹ |
|-----------|---------------|------|------|
| TradeEntry.js | symbol, broker, reasons, scenarioç­‰ | #sanitize() | âœ… |
| TradeEdit.js | pair, broker, scenario, reflectionTextç­‰ | #sanitize() | âœ… |
| NoteManagerModule.js | memo, marketView | cleanupNoteHTML() | âœ… |
| ExpenseManagerModule.js | category, description, memo | #sanitize() | âœ… |
| SyncModule.js | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | #toUserMessage() | âœ… |

**cleanupNoteHTML() ã®å¼·åŒ–å†…å®¹**:
```javascript
cleanupNoteHTML(html) {
    return html
        // scriptã‚¿ã‚°é™¤å»
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
        // iframeã‚¿ã‚°é™¤å»
        .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©é™¤å»
        .replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi, '')
        // javascript:ãƒ—ãƒ­ãƒˆã‚³ãƒ«é™¤å»
        .replace(/javascript\s*:/gi, '')
        // è¨±å¯ã•ã‚ŒãŸã‚¿ã‚°ã®ã¿æ®‹ã™
        .replace(/<(?!\/?(p|br|b|strong|i|em|u|ul|ol|li|h[1-6]|div|span)\b)[^>]+>/gi, '');
}
```

---

## 7. localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

### SEC-007: localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ âœ… å®Ÿè£…å®Œäº†

### é©ç”¨æ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ | æ¤œè¨¼é–¢æ•° | çŠ¶æ…‹ |
|-----------|-----------|---------|------|
| SettingsModule.js | `brokers` | `isBrokersFormat` | âœ… |
| SettingsModule.js | `favoritePairs` | `isFavoritePairsFormat` | âœ… |
| SettingsModule.js | `goalsData` | `isGoalsFormat` | âœ… |
| TradeManager-nomodule.js | `trades` | `isTradesFormat` | âœ… |
| NoteManagerModule.js | `notes` | `isObject` | âœ… |
| NoteManagerModule.js | `monthlyMemos` | `isMonthlyMemosFormat` | âœ… |
| NoteManagerModule.js | `collapseState` | `isObject` | âœ… |
| ExpenseManagerModule.js | `expenses` | `isArray` | âœ… |
| ExpenseManagerModule.js | `accordion state` | `isObject` | âœ… |
| CapitalManagerModule.js | `depositWithdrawals` | `isArray` | âœ… |
| ClosingManagerModule.js | `tc_closed_periods` | `isClosedPeriodsFormat` | âœ… |

---

## 8. Supabase Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ âœ… å®Ÿè£…å®Œäº†

### SEC-008: Storage RLS

**ãƒã‚±ãƒƒãƒˆå**: `trade-images`

**ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ **:
```
{user_id}/
â”œâ”€â”€ trades/
â”‚   â””â”€â”€ {trade_id}/
â”‚       â”œâ”€â”€ chart1.jpg
â”‚       â”œâ”€â”€ chart2.jpg
â”‚       â””â”€â”€ chart3.jpg
â””â”€â”€ notes/
    â””â”€â”€ {date}/
        â””â”€â”€ image1.jpg
```

### RLSãƒãƒªã‚·ãƒ¼ âœ… è¨­å®šæ¸ˆã¿

```sql
-- ãƒã‚±ãƒƒãƒˆä½œæˆï¼ˆprivateï¼‰
INSERT INTO storage.buckets (id, name, public)
VALUES ('trade-images', 'trade-images', false);

-- RLSãƒãƒªã‚·ãƒ¼: è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "Users can access own folder"
ON storage.objects FOR ALL
USING (
  bucket_id = 'trade-images' 
  AND (storage.foldername(name))[1] = auth.uid()::text
)
WITH CHECK (
  bucket_id = 'trade-images' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ

| ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ | çŠ¶æ…‹ |
|---------|------|------|
| éå…¬é–‹ãƒã‚±ãƒƒãƒˆ | `public: false` ã§å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ | âœ… |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†é›¢ | user_idãƒ•ã‚©ãƒ«ãƒ€ã§ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ | âœ… |
| RLSãƒãƒªã‚·ãƒ¼ | è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿CRUDå¯èƒ½ | âœ… |
| ç½²åä»˜ãURL | ç”»åƒè¡¨ç¤ºæ™‚ã¯ç½²åä»˜ãURLã‚’ç”Ÿæˆ | âœ… |

### ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®æ¤œè¨¼ âœ… å®Ÿè£…æ¸ˆã¿

```javascript
// ImageHandler.uploadToCloud()
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

async uploadToCloud(file, path) {
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—æ¤œè¨¼
    if (!ALLOWED_TYPES.includes(file.type)) {
        throw new Error('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæ¤œè¨¼
    if (file.size > MAX_FILE_SIZE) {
        throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ5MBã‚’è¶…ãˆã¦ã„ã¾ã™');
    }
    
    // ... ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
}
```

---

## 9. é€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ç¾çŠ¶ï¼ˆâœ… å¯¾å¿œæ¸ˆã¿ï¼‰

| é …ç›® | çŠ¶æ…‹ | èª¬æ˜ |
|------|------|------|
| HTTPS | âœ… | GitHub Pagesæ¨™æº– |
| APIé€šä¿¡ | âœ… | Supabaseã¯å…¨ã¦HTTPS |
| APIã‚­ãƒ¼ | âœ… | anon keyã®ã¿ï¼ˆå…¬é–‹å¯ï¼‰ |
| Storageé€šä¿¡ | âœ… | HTTPS + ç½²åä»˜ãURL |

---

## 10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### SEC-004: ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ âœ… å®Ÿè£…å®Œäº†

**SyncModule v1.6.0 #toUserMessage()ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**:

```javascript
#toUserMessage(error) {
    // SecureErrorãŒåˆ©ç”¨å¯èƒ½ãªã‚‰ãã‚Œã‚’ä½¿ç”¨
    if (typeof SecureError !== 'undefined' && SecureError.toUserMessage) {
        return SecureError.toUserMessage(error);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
    if (!error) return 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    
    const message = error.message || String(error);
    
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
    if (message.includes('Failed to fetch') || message.includes('NetworkError')) {
        return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
    }
    
    // èªè¨¼ã‚¨ãƒ©ãƒ¼
    if (message.includes('JWT') || message.includes('token') || message.includes('auth')) {
        return 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
    }
    
    // ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
}
```

---

## 11. ç›£æŸ»ãƒ»ãƒ­ã‚°

ï¼ˆå¤‰æ›´ãªã— - v1.3ã¨åŒã˜ï¼‰

---

## 12. å°†æ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µ

ï¼ˆå¤‰æ›´ãªã— - v1.3ã¨åŒã˜ï¼‰

---

## 13. å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Phase 3.6ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºç›¤ï¼‰âœ… å®Œäº†

| é …ç›® | çŠ¶æ…‹ | å®Œäº†æ—¥ |
|------|------|--------|
| security.js ä½œæˆ | âœ… | 2025-12-30 |
| SecurityUtils å®Ÿè£… | âœ… | 2025-12-30 |
| InputValidator å®Ÿè£… | âœ… | 2025-12-30 |
| SecureError å®Ÿè£… | âœ… | 2025-12-30 |
| StorageValidator å®Ÿè£… | âœ… | 2025-12-30 |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š | âœ… | 2025-12-30 |
| å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®localStorageèª­ã¿è¾¼ã¿ä¿®æ­£ | âœ… | 2025-12-30 |

### Phase 4ï¼ˆãƒ‡ãƒ¼ã‚¿åŒæœŸ + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é©ç”¨ï¼‰âœ… å®Œäº†

| é …ç›® | çŠ¶æ…‹ | å®Œäº†æ—¥ |
|------|------|--------|
| trades åŒæœŸ | âœ… | 2025-12-30 |
| notes åŒæœŸ | âœ… | 2026-01-03 |
| expenses åŒæœŸ | âœ… | 2026-01-04 |
| capital_records åŒæœŸ | âœ… | 2026-01-04 |
| user_settings åŒæœŸ | âœ… | 2026-01-04 |
| Supabase Storage å®Ÿè£… | âœ… | 2026-01-05 |
| Storage RLSãƒãƒªã‚·ãƒ¼è¨­å®š | âœ… | 2026-01-05 |
| **TradeEntry.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨** | **âœ…** | **2026-01-14** |
| **TradeEdit.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨** | **âœ…** | **2026-01-14** |
| **NoteManagerModule ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨** | **âœ…** | **2026-01-14** |
| **ExpenseManagerModule ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨** | **âœ…** | **2026-01-14** |
| **SyncModule ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é©ç”¨** | **âœ…** | **2026-01-14** |

---

## 14. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆé …ç›®

### èªè¨¼ãƒ†ã‚¹ãƒˆ âœ… å®Ÿæ–½æ¸ˆã¿

| # | ãƒ†ã‚¹ãƒˆé …ç›® | çŠ¶æ…‹ |
|---|-----------|------|
| 1 | æ­£å¸¸ãƒ­ã‚°ã‚¤ãƒ³ | âœ… |
| 2 | ä¸æ­£ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— | âœ… |
| 3 | 24æ™‚é–“å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ | âœ… |
| 4 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ å¤‰æ›´ | âœ… |
| 5 | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ | âœ… |
| 6 | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ | âœ… |

### XSSãƒ†ã‚¹ãƒˆ âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼ˆ2026-01-14ï¼‰

| # | ãƒ†ã‚¹ãƒˆé …ç›® | å…¥åŠ›å€¤ | æœŸå¾…çµæœ | çŠ¶æ…‹ |
|---|-----------|--------|---------|------|
| 1 | ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥ | `<script>alert(1)</script>` | ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— | âœ… |
| 2 | ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© | `<img onerror=alert(1)>` | é™¤å» | âœ… |
| 3 | iframeåŸ‹ã‚è¾¼ã¿ | `<iframe src="x"></iframe>` | é™¤å» | âœ… |
| 4 | javascript:ãƒ—ãƒ­ãƒˆã‚³ãƒ« | `<a href="javascript:alert(1)">` | é™¤å» | âœ… |

### Storageãƒ†ã‚¹ãƒˆ âœ… ãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼ˆ2026-01-05ï¼‰

| # | ãƒ†ã‚¹ãƒˆé …ç›® | æœŸå¾…çµæœ | çŠ¶æ…‹ |
|---|-----------|---------|------|
| 30 | è‡ªåˆ†ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | æˆåŠŸ | âœ… |
| 31 | è‡ªåˆ†ã®ç”»åƒã‚’å–å¾— | æˆåŠŸ | âœ… |
| 32 | ä»–äººã®ç”»åƒã«ã‚¢ã‚¯ã‚»ã‚¹ | å¤±æ•—ï¼ˆ403ï¼‰ | âœ… |
| 33 | è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ | å¤±æ•— | âœ… |
| 34 | 5MBã‚’è¶…ãˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ« | å¤±æ•— | âœ… |

---

## 15. å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### security.js v1.0.1

ï¼ˆå†…å®¹ã¯å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ - çœç•¥ï¼‰

### AuthModule.js v1.4.0 ğŸ†•

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `js/auth/AuthModule.js`
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.4.0
**æ›´æ–°æ—¥**: 2026-01-14

**å¤‰æ›´å±¥æ­´**:
- v1.0.0 (2025-12-17): åˆç‰ˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
- v1.1.0 (2025-12-29): ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–æ©Ÿèƒ½è¿½åŠ ã€SecureErrorçµ±åˆ
- v1.1.1 (2025-01-04): SyncModuleè‡ªå‹•åˆæœŸåŒ–è¿½åŠ 
- v1.2.0 (2026-01-05): ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸè¿½åŠ ï¼ˆsyncAllDataFromCloudï¼‰
- v1.3.0 (2026-01-14): ãƒã‚¤ãƒšãƒ¼ã‚¸å¤‰æ›´æ©Ÿèƒ½è¿½åŠ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã€ãƒ¡ãƒ¼ãƒ«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰
- **v1.4.0 (2026-01-14): ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½è¿½åŠ ï¼ˆPASSWORD_RECOVERYæ¤œçŸ¥ã€è­¦å‘ŠãƒãƒŠãƒ¼ï¼‰**

**Public API**:
```javascript
return {
    init: init,
    getCurrentUser: function() { return currentUser; },
    getUsername: getUsername,
    isLoggedIn: function() { return currentUser !== null; },
    showAuthModal: showAuthModal,
    hideAuthModal: hideAuthModal,
    logout: handleLogout,
    logoutWithConfirm: logoutWithConfirm,
    updateMyPageDisplay: updateMyPageDisplay,
    // v1.3.0 è¿½åŠ 
    openChangeUsernameModal: openChangeUsernameModal,
    closeChangeUsernameModal: closeChangeUsernameModal,
    changeUsername: changeUsername,
    openChangeEmailModal: openChangeEmailModal,
    closeChangeEmailModal: closeChangeEmailModal,
    changeEmail: changeEmail,
    openChangePasswordModal: openChangePasswordModal,
    closeChangePasswordModal: closeChangePasswordModal,
    changePassword: changePassword
};
```

### SyncModule.js v1.6.0 ğŸ†•

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `js/sync/SyncModule.js`
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.6.0
**æ›´æ–°æ—¥**: 2026-01-14

**å¤‰æ›´å±¥æ­´**:
- v1.0.1 (2025-12-30): tradesåŒæœŸå®Ÿè£…
- v1.1.1 (2026-01-03): notesåŒæœŸè¿½åŠ 
- v1.2.0 (2026-01-04): expensesåŒæœŸè¿½åŠ 
- v1.3.0 (2026-01-04): capital_recordsåŒæœŸè¿½åŠ 
- v1.4.0 (2026-01-04): user_settingsåŒæœŸè¿½åŠ ï¼ˆä¸€æ‹¬ä¿å­˜æ–¹å¼ï¼‰
- v1.5.2 (2026-01-05): Supabase Storageç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµ±åˆ
- v1.5.3 (2026-01-09): goals/iconåŒæœŸè¿½åŠ 
- **v1.6.0 (2026-01-14): ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆ#toUserMessage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¿½åŠ ï¼‰**

---

## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆPhase 4å®Œäº†ç¢ºèªï¼‰âœ… å…¨å®Œäº†

### Supabaseè¨­å®š

- [x] ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã‚’24æ™‚é–“ã«è¨­å®š
- [x] å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãŒæœ‰åŠ¹
- [x] å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ã„
- [x] Storageãƒã‚±ãƒƒãƒˆä½œæˆ
- [x] Storage RLSãƒãƒªã‚·ãƒ¼è¨­å®š
- [x] Secure email change â†’ ã‚ªãƒ•

### ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»ä¿®æ­£

- [x] js/core/security.js ä½œæˆ
- [x] js/sync/SyncModule.js ä½œæˆï¼ˆv1.6.0ï¼‰
- [x] js/auth/AuthModule.js æ›´æ–°ï¼ˆv1.3.0ï¼‰
- [x] ImageHandler.uploadToCloud() å®Ÿè£…

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é©ç”¨

- [x] TradeEntry.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨
- [x] TradeEdit.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨
- [x] NoteManagerModule.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨
- [x] ExpenseManagerModule.js ã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨
- [x] SyncModule.js ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é©ç”¨

### ãƒ‡ãƒ¼ã‚¿åŒæœŸ

- [x] trades åŒæœŸå®Œäº†
- [x] notes åŒæœŸå®Œäº†
- [x] expenses åŒæœŸå®Œäº†
- [x] capital_records åŒæœŸå®Œäº†
- [x] user_settings åŒæœŸå®Œäº†
- [x] ç”»åƒï¼ˆSupabase Storageï¼‰åŒæœŸå®Œäº†
- [x] goals/icon åŒæœŸå®Œäº†

---

## æ›´æ–°å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|---------|
| v1.0 | 2025-12-19 | åˆç‰ˆä½œæˆ |
| v1.1 | 2025-12-19 | SEC-007 localStorageãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’è¿½åŠ  |
| v1.2 | 2025-12-30 | Phase 3.6å®Œäº†ã‚’åæ˜ ã€ãƒ†ã‚¹ãƒˆçµæœè¿½è¨˜ |
| v1.3 | 2026-01-04 | Phase 4ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†ã‚’åæ˜ ã€SEC-008 Supabase Storage RLSè¿½åŠ ã€SyncModule v1.4.0è¿½è¨˜ |
| v1.4 | 2026-01-14 | Phase 4å®Œäº†ã‚’åæ˜ ã€SEC-009ãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ‹ã‚¿ã‚¤ã‚ºè¿½åŠ ã€AuthModule v1.3.0ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸å¤‰æ›´ï¼‰ã€SyncModule v1.6.0ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰ã€Supabaseè¨­å®šãƒ¡ãƒ¢è¿½åŠ  |
| **v1.4.1** | **2026-01-14** | **SEC-011ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€AuthModule v1.4.0è¿½åŠ ** |

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Trading Completeã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã®æŒ‡é‡ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚*

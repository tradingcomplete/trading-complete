# Trading Complete セキュリティ要件定義書 v1.4

**作成日**: 2025-12-19  
**更新日**: 2026-01-04  
**対象**: Trading Complete クラウド版  
**目的**: 金融データを扱うシステムとしてのセキュリティ基準を定義

---

## 📋 目次

1. [セキュリティ方針](#1-セキュリティ方針)
2. [脅威モデル](#2-脅威モデル)
3. [認証セキュリティ](#3-認証セキュリティ)
4. [データセキュリティ](#4-データセキュリティ)
5. [入力検証](#5-入力検証)
6. [エラーハンドリング](#6-エラーハンドリング)
7. [Supabase Storage RLS](#7-supabase-storage-rls) 🆕
8. [セキュリティテスト項目](#8-セキュリティテスト項目)
9. [実装済みコンポーネント](#9-実装済みコンポーネント)

---

## 1. セキュリティ方針

### 基本原則

| 原則 | 説明 |
|------|------|
| 最小権限 | ユーザーは自分のデータのみアクセス可能 |
| 多層防御 | RLS + 入力検証 + サニタイズ |
| セキュアデフォルト | 安全な初期設定 |
| 透明性 | セキュリティ問題は隠さない |

### 保護対象データ

| データ種別 | 機密度 | 保護方式 |
|-----------|--------|---------|
| トレード記録 | 高 | RLS + 暗号化通信 |
| 収支データ | 高 | RLS + 暗号化通信 |
| 経費情報 | 中 | RLS + 暗号化通信 |
| メールアドレス | 中 | RLS + ハッシュ化 |
| パスワード | 最高 | Supabase Auth（bcrypt） |
| **画像データ** | **中** | **Storage RLS** 🆕 |

---

## 2. 脅威モデル

### 想定される脅威

| ID | 脅威 | 影響度 | 対策 | 状態 |
|----|------|--------|------|------|
| T-01 | XSS攻撃 | 高 | security.jsサニタイズ | ✅ |
| T-02 | SQLインジェクション | 高 | Supabase SDK使用 | ✅ |
| T-03 | CSRF攻撃 | 中 | Supabase Auth対応 | ✅ |
| T-04 | セッションハイジャック | 高 | 24時間タイムアウト | ✅ |
| T-05 | ブルートフォース | 中 | Supabase Rate Limit | ✅ |
| T-06 | 他ユーザーデータアクセス | 最高 | RLS | ✅ |
| T-07 | 不正データ注入 | 中 | StorageValidator | ✅ |
| **T-08** | **他ユーザー画像アクセス** | **高** | **Storage RLS** | **✅** 🆕 |

---

## 3. 認証セキュリティ

（前バージョンと同じ - 省略）

---

## 4. データセキュリティ

（前バージョンと同じ - 省略）

---

## 5. 入力検証

（前バージョンと同じ - 省略）

---

## 6. エラーハンドリング

（前バージョンと同じ - 省略）

---

## 7. Supabase Storage RLS 🆕

### SEC-008: Storage Row Level Security

**実装日**: 2026-01-04  
**状態**: ✅ 実装完了

#### バケット設定

| 項目 | 値 |
|------|-----|
| バケット名 | `trade-images` |
| 公開設定 | Private（非公開） |
| ファイルサイズ制限 | 5MB |
| 許可MIMEタイプ | image/jpeg, image/png, image/gif, image/webp |

#### RLSポリシー

```sql
-- ポリシー名: "Users can access own folder"
-- 操作: ALL（SELECT, INSERT, UPDATE, DELETE）
-- 対象: authenticated ロール

bucket_id = 'trade-images' 
AND (storage.foldername(name))[1] = auth.uid()::text
```

#### フォルダ構造

```
trade-images/
└── {user_id}/           ← RLSで保護
    ├── trades/
    │   └── {trade_id}/
    │       ├── chart1.jpg
    │       ├── chart2.jpg
    │       └── chart3.jpg
    └── notes/
        └── {date}/
            └── image1.jpg
```

#### アクセス制御

| 操作 | 自分のフォルダ | 他人のフォルダ |
|------|--------------|--------------|
| アップロード | ✅ 許可 | ❌ 拒否 |
| 取得 | ✅ 許可 | ❌ 拒否 |
| 削除 | ✅ 許可 | ❌ 拒否 |
| 一覧 | ✅ 許可 | ❌ 拒否 |

#### 署名付きURL

| 項目 | 値 |
|------|-----|
| 有効期限 | 1時間（3600秒） |
| 生成方法 | `supabase.storage.createSignedUrl()` |
| 用途 | 画像表示時のアクセス |

---

## 8. セキュリティテスト項目

### 認証テスト ✅ 一部実施済み

（前バージョンと同じ - 省略）

### XSSテスト ✅ テスト済み（2025-12-30）

（前バージョンと同じ - 省略）

### 入力値検証テスト ✅ テスト済み（2025-12-30）

（前バージョンと同じ - 省略）

### Storageテスト ✅ 基本テスト完了 🆕

| # | テスト項目 | 期待結果 | 状態 | 実施日 |
|---|-----------|---------|------|--------|
| 30 | 自分の画像をアップロード | 成功 | ✅ | 2026-01-04 |
| 31 | 自分の画像を取得（署名付きURL） | 成功 | ✅ | 2026-01-04 |
| 32 | 他人の画像にアクセス | 失敗（403） | ⬜ | - |
| 33 | 許可されていないファイル形式 | 失敗 | ⬜ | - |
| 34 | 5MBを超えるファイル | 失敗 | ⬜ | - |

**テスト結果詳細**:

```
テスト#30: アップロード成功
- パス: 406bf898-.../trades/test_image_.../chart1.jpg
- サイズ: 約100バイト（テスト画像）

テスト#31: 署名付きURL取得成功
- URL: https://xxx.supabase.co/storage/v1/object/sign/trade-images/...
- 画像表示: 確認済み（1x1ピクセル緑画像）
```

---

## 9. 実装済みコンポーネント詳細

### security.js v1.0.1

（前バージョンと同じ - 省略）

### AuthModule.js v1.1.0

（前バージョンと同じ - 省略）

### SyncModule.js v1.5.0 🆕

**ファイルパス**: `js/sync/SyncModule.js`  
**バージョン**: 1.5.0  
**更新日**: 2026-01-04

**変更履歴**:
- v1.0.1 (2025-12-30): trades同期実装
- v1.1.1 (2026-01-03): notes同期追加
- v1.2.0 (2026-01-04): expenses同期追加
- v1.3.0 (2026-01-04): capital_records同期追加
- v1.4.0 (2026-01-04): user_settings同期追加
- **v1.5.0 (2026-01-04): 画像アップロード統合（Supabase Storage）**

**セキュリティ機能**:
- ログイン必須チェック（`#userId`がなければ拒否）
- RLSによるユーザーデータ分離
- **画像アップロード時のユーザーID検証** 🆕
- EventBus連携（同期状態の通知）

### ImageHandler.js v1.1.0 🆕

**ファイルパス**: `js/handlers/imageHandler.js`  
**バージョン**: 1.1.0  
**更新日**: 2026-01-04

**セキュリティ機能**:
- ファイルサイズ制限（5MB）
- MIMEタイプ検証
- **Storage RLSによるアクセス制御** 🆕
- **署名付きURL（1時間有効）** 🆕

---

## 📋 チェックリスト（Phase 4.5 確認）

### Supabase Storage設定

- [x] バケット `trade-images` 作成
- [x] Private（非公開）設定
- [x] ファイルサイズ制限（5MB）
- [x] MIMEタイプ制限
- [x] RLSポリシー設定
- [x] RLSポリシー動作確認

### コード実装

- [x] ImageHandler.uploadToCloud() 実装
- [x] ImageHandler.getSignedUrl() 実装
- [x] ImageHandler.deleteFromCloud() 実装
- [x] SyncModule.#uploadTradeImages() 実装
- [x] userId検証ロジック
- [ ] ノート画像アップロード対応

### テスト

- [x] 自分のフォルダへのアップロード成功
- [x] 署名付きURLで画像取得成功
- [ ] 他人のフォルダへのアクセス拒否確認
- [ ] 不正ファイル形式の拒否確認
- [ ] 大きすぎるファイルの拒否確認

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-12-19 | 初版作成 |
| v1.1 | 2025-12-19 | SEC-007 localStorageデータ検証を追加 |
| v1.2 | 2025-12-30 | Phase 3.6完了を反映、テスト結果追記 |
| v1.3 | 2026-01-04 | Phase 4データ同期完了、SEC-008 Storage RLS追加 |
| **v1.4** | **2026-01-04** | **Phase 4.5 Storage基本実装完了、Storageテスト結果追記、ImageHandler v1.1.0追記** |

---

*このドキュメントは、Trading Completeのセキュリティ実装の指針として使用してください。*

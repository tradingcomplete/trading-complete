# 画像説明欄追加 - 要件定義書 v1.7

**作成日**: 2026-01-17  
**更新日**: 2026-01-23（v1.7: 画像モーダル統合・新規エントリー編集対応）  
**優先度**: MEDIUM（ユーザビリティ向上）  
**目標**: 画像に題名・説明を追加し、何の画像か一目で分かるようにする  
**技術方針**: MODULES.md標準パターン準拠  
**状態**: ✅ **完了**

---

## 📋 実装進捗サマリー

| Phase | 内容 | 状態 |
|-------|------|------|
| Phase 1 | imageUtils.js 基盤整備 | ✅ 完了 |
| Phase 2 | 画像追加モーダル改修（Step2追加） | ✅ 完了 |
| Phase 3 | サムネイル表示・拡大モーダル改修 | ✅ 完了 |
| Phase 4 | （Phase 3に統合） | ✅ 完了 |
| Phase 5 | 説明編集機能（✏️ボタン） | ✅ 完了 |
| Phase 6 | テスト・調整・バグ修正 | ✅ 完了 |
| Phase 7 | URL期限切れ問題対応 | ✅ 完了 |
| Phase 8 | 画像モーダル統合・UX改善 | ✅ **完了** |

---

## ✅ Phase 8: 画像モーダル統合・UX改善（v1.7 新規）

### 8-A: 画像モーダル統合

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-A-1 | Step2削除、imageCaptionEditModalに統合 | script.js, index.html | ✅ 完了 |
| 8-A-2 | showImageAddStep2をimageCaptionEditModal呼び出しに変更 | script.js | ✅ 完了 |
| 8-A-3 | captionEditMode変数追加（'edit'/'add'） | script.js | ✅ 完了 |
| 8-A-4 | saveImageCaptionEditを追加モード/編集モード両対応 | script.js | ✅ 完了 |
| 8-A-5 | closeImageAddModalから状態リセット削除（責任分離） | script.js | ✅ 完了 |

### 8-B: 新規エントリー画像編集対応

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-B-1 | 新規エントリー画像クリックにcontext追加 | script.js | ✅ 完了 |
| 8-B-2 | showImageModalWithCaptionで常に説明エリア表示 | script.js | ✅ 完了 |
| 8-B-3 | openModalImageEditにnewEntry対応追加 | script.js | ✅ 完了 |
| 8-B-4 | 二重ネスト問題修正（actualSrc取り出し） | script.js | ✅ 完了 |

### 8-C: 相場ノート画像編集修正

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-C-1 | tempNoteEditImagesから優先取得 | script.js | ✅ 完了 |
| 8-C-2 | 「画像が見つかりません」エラー解消 | script.js | ✅ 完了 |

### 8-D: デザイン統一・追加機能

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-D-1 | deleteImageInEdit関数追加 | script.js | ✅ 完了 |
| 8-D-2 | changeImageInEdit関数追加 | script.js | ✅ 完了 |
| 8-D-3 | backToImageAddStep1関数復活 | script.js | ✅ 完了 |

---

## ✅ Phase 6 完了タスク一覧

### 6-A: 新規エントリー画面

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-A-1 | chart-image-wrapper追加 | index.html | ✅ 完了 |
| 6-A-2 | caption要素を枠外に配置 | index.html | ✅ 完了 |
| 6-A-3 | handleProcessedImage修正 | script.js | ✅ 完了 |
| 6-A-4 | CSS調整（枠外題名） | 6_responsive.css | ✅ 完了 |

### 6-B: トレード関連

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-B-1 | トレード記録タブの題名表示 | TradeList.js | ✅ 完了 |
| 6-B-2 | 拡大モーダルの完全非表示 | script.js | ✅ 完了 |
| 6-B-3 | トレード詳細モーダルの題名表示 | 6_responsive.css | ✅ 完了 |
| 6-B-4 | 拡大モーダルに編集ボタン追加 | index.html, script.js, CSS | ✅ 完了 |
| 6-B-5 | 編集後の戻り先制御 | script.js | ✅ 完了 |

### 6-C: Supabase同期対応

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-C-1 | トレード画像 title/description保持 | SyncModule.js | ✅ 完了 |
| 6-C-2 | ノート画像 title/description保持 | SyncModule.js | ✅ 完了 |

### 6-D: 相場ノート関連

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-D-1 | ノート編集画面の題名表示 | NoteManagerModule.js | ✅ 完了 |
| 6-D-2 | ノート編集画面の画像クリック拡大表示 | NoteManagerModule.js | ✅ 完了 |
| 6-D-3 | 週間プレビューの画像拡大表示 | NoteManagerModule.js | ✅ 完了 |

### 6-E: テスト

| # | タスク | 状態 |
|---|--------|------|
| 6-E-1 | 後方互換性テスト（旧データ） | ✅ 完了 |
| 6-E-2 | レスポンシブ確認 | ✅ 完了 |
| 6-E-3 | テーマ確認 | ✅ 完了 |

---

## ✅ Phase 7: URL期限切れ問題対応

### 問題
- v1.2.0でv1.1.0の期限切れURL自動更新機能が欠落
- 1日経過後に画像が表示されなくなる

### 解決
- imageUtils.js v1.3.0で機能統合

| # | タスク | 状態 |
|---|--------|------|
| 7-1 | imageUtils.js v1.3.0作成（v1.1.0+v1.2.0統合） | ✅ 完了 |
| 7-2 | 既存データの復元スクリプト実行 | ✅ 完了 |
| 7-3 | path情報がDBに保存されることを確認 | ✅ 完了 |

---

## 📐 実装済み機能サマリー

### imageUtils.js v1.3.0

**基本関数**:
- `getImageSrc()` - 画像URLを取得
- `hasValidImage()` - 有効な画像か判定
- `isUrlImage()` - URL形式か判定
- `isBase64Image()` - Base64形式か判定

**説明機能（v1.2.0）**:
- `normalizeImageData()` - 画像データ正規化
- `getImageTitle()` - 題名を取得
- `getImageDescription()` - 説明を取得
- `createImageData()` - 画像データ作成
- `updateImageCaption()` - 題名・説明更新
- `hasImageCaption()` - 題名/説明があるか判定

**URL期限切れ処理（v1.1.0）**:
- `getUrlExpiration()` - URL有効期限を取得
- `isUrlExpired()` - 期限切れ判定（1時間余裕）
- `getValidImageSrc()` - 期限切れなら自動更新
- `refreshTradeImageUrls()` - トレード画像一括更新
- `refreshNoteImageUrls()` - ノート画像一括更新

### script.js 画像関連関数（v1.7更新）

**画像追加関連**:
- `showImageUploadOptions()` - 画像追加オプション表示
- `showImageAddStep2()` - ファイル選択後、編集モーダル表示（統合後）
- `closeImageAddModal()` - 追加モーダルを閉じる（状態リセットなし）
- `changeImageInEdit()` - 編集モーダルからStep1に戻る
- `backToImageAddStep1()` - Step1に戻る

**画像拡大・編集関連**:
- `showImageModalWithCaption()` - 拡大モーダル表示（context対応）
- `toggleImageCaption()` - 説明エリア表示/非表示
- `openModalImageEdit()` - 拡大モーダルから編集モーダルを開く（newEntry対応）
- `openImageCaptionEdit()` - 編集モーダルを開く（source引数対応）
- `saveImageCaptionEdit()` - 保存（追加/編集モード両対応）
- `closeImageCaptionEditModal()` - 編集モーダルを閉じる
- `deleteImageInEdit()` - 編集モーダルから画像を削除

**新規追加変数（v1.7）**:
- `captionEditMode` - 'edit' または 'add'
- `pendingImageForAdd` - 追加モード用の一時画像データ
- `currentModalImageContext` - 拡大モーダル用コンテキスト

### 画像データ構造

```javascript
// 完全な画像データ構造
{
    src: "https://...",           // 表示用URL
    url: "https://...",           // Supabase署名付きURL
    path: "userId/trades/xxx/chart1.jpg",  // ⚠️ 重要: 復元に必要
    title: "エントリー時の日足",
    description: "サポートラインブレイク",
    timestamp: "2026-01-22T..."
}
```

### 画面別機能

| 画面 | 題名表示 | 拡大表示 | 編集機能 |
|------|---------|---------|---------|
| 新規エントリー | ✅ 枠外 | ✅ 鉛筆付き | ✅ 鉛筆（v1.7） |
| トレード記録タブ | ✅ サムネイル下 | ✅ 題名・説明付き | ✅ 鉛筆 |
| トレード詳細モーダル | ✅ 画像下 | ✅ 題名・説明付き | ✅ 鉛筆 |
| 拡大モーダル | ✅ | - | ✅ 鉛筆 |
| 相場ノート編集画面 | ✅ オーバーレイ | ✅ 鉛筆付き | ✅ 鉛筆（v1.7） |
| 相場ノート詳細 | ✅ 画像下 | ✅ 題名・説明付き | ✅ 鉛筆 |
| 週間プレビュー | - | ✅ 題名・説明付き | ✅ 鉛筆 |

---

## 📝 修正指示書一覧

### Phase 6-7

| # | ファイル名 | 対象 |
|---|-----------|------|
| 1 | SyncModule_修正指示_title_description対応.md | トレード画像同期 |
| 2 | SyncModule_ノート画像_title_description対応_修正指示書.md | ノート画像同期 |
| 3 | 拡大モーダル編集ボタン追加_修正指示書.md | 拡大モーダル |
| 4 | 編集後の戻り先制御_修正指示書_v2.md | 編集後の遷移 |
| 5 | トレード詳細モーダル題名表示_修正指示書.md | 詳細モーダルCSS |
| 6 | NoteManagerModule_ノート編集画面題名表示_修正指示書.md | ノート題名表示 |
| 7 | NoteManagerModule_画像クリック拡大表示_修正指示書.md | ノート画像クリック |
| 8 | TradeList_修正指示_サムネイル題名表示.md | トレード一覧 |
| 9 | NoteManagerModule_週間プレビュー画像拡大_修正指示書.md | 週間プレビュー |
| 10 | imageUtils.js v1.3.0（完成版ファイル） | URL期限切れ対応 |

### Phase 8（v1.7 新規）

| # | ファイル名 | 対象 |
|---|-----------|------|
| 11 | script_js_画像モーダル統合_修正指示書.md | Step2削除・統合 |
| 12 | script_js_デザイン統一_修正指示書.md | deleteImageInEdit追加 |
| 13 | script_js_画像追加フロー修正_MODULES準拠_指示書.md | 責任分離 |
| 14 | script_js_鉛筆マーク常時表示_MODULES準拠_修正指示書.md | newEntry対応 |
| 15 | script_js_二重ネスト問題修正v2_MODULES準拠_指示書.md | actualSrc取り出し |
| 16 | script_js_相場ノート画像編集修正_MODULES準拠_指示書.md | tempNoteEditImages優先 |

---

## 📁 修正ファイル一覧

| ファイル | 修正内容 |
|---------|---------|
| imageUtils.js | v1.3.0（説明機能+URL自動更新） |
| index.html | モーダルHTML、chart-image-wrapper追加、Step2削除 |
| script.js | 画像モーダル統合、newEntry対応、二重ネスト修正、相場ノート修正（v1.7で+458行） |
| 6_responsive.css | 各種題名表示スタイル、拡大モーダル編集ボタン |
| TradeList.js | サムネイル下題名表示、拡大表示対応 |
| TradeDetail.js | 題名表示、context引数対応 |
| NoteManagerModule.js | displayNoteImage、#restoreImagesAsync、週間プレビュー修正 |
| SyncModule.js | #uploadTradeImages、#uploadNoteImages（title/description/path保持） |

---

## ⚠️ 重要な教訓

### バージョン管理の注意点
v1.2.0作成時にv1.1.0の機能（URL期限切れ処理）を含めなかったため、画像が消える問題が発生。

**今後の対策**:
- バージョンアップ時は前バージョンの全機能を含めること
- imageUtils.jsは単一ファイルで全機能を管理

### 画像データの必須フィールド
`path`フィールドがないと期限切れ時に復元不可能。

**必須フィールド**:
```javascript
{
    url: "署名付きURL",
    path: "Storage内のパス"  // ⚠️ これがないと復元不可
}
```

### 二重ネスト問題（v1.7追加）
オブジェクト形式の画像データを`createImageData()`に渡すと二重ネストが発生。

**対策**:
```javascript
// ❌ 問題のあるコード
createImageData(imageData, title, desc)  // imageDataがオブジェクトの場合

// ✅ 修正後
const actualSrc = getImageSrc(imageData);
createImageData(actualSrc, title, desc);
```

### 状態管理の責任分離（v1.7追加）
モーダルを閉じる関数で状態リセットを行うと、処理完了前にデータが消える。

**対策**:
- `closeImageAddModal()` - UIを閉じるのみ（状態リセットなし）
- 状態リセットは処理完了後に適切なタイミングで行う

---

## 🎉 完了

画像説明欄追加機能の実装が完了しました。

**実装期間**: 2026-01-17 〜 2026-01-23（7日間）

**主な成果**:
- 画像に題名・説明を追加可能
- 全画面で題名が表示される
- 拡大表示で詳細を確認可能
- 各画面から編集可能（新規エントリー含む）
- 画像モーダルを統合し、UXを統一
- Supabaseへの同期対応
- URL期限切れ時の自動更新対応

**script.js 行数推移**: 5,408行 → 5,866行（+458行）

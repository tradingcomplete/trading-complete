# 画像説明欄追加 要件定義書 v2.1

**作成日**: 2026-01-22  
**更新日**: 2026-01-25  
**対象**: Trading Complete - 画像機能全般

---

## 📋 機能概要

トレード記録・相場ノートの画像に「題名」「説明（コメント）」を追加できる機能

---

## ✅ 完了した作業

### 1. CSS修正（2026-01-24）
| 修正 | 内容 | 状態 |
|------|------|------|
| 6_responsive.css | 改行対応（white-space: pre-wrap） | ✅ 完了 |
| 6_responsive.css | レスポンシブ横幅（768px以下で95%） | ✅ 完了 |

### 2. 画像圧縮設定の高画質化（2026-01-24）
| 修正 | 内容 | 状態 |
|------|------|------|
| imageHandler.js | PNG形式に変更（文字くっきり） | ✅ 完了 |
| imageHandler.js | chart: 1600×900px / quality 1.0 | ✅ 完了 |
| imageHandler.js | note: 1600×1200px / quality 1.0 | ✅ 完了 |

### 3. トレード画像変更機能（2026-01-24）
| 修正箇所 | 内容 | 状態 |
|---------|------|------|
| changeImageInEdit | 置換用コンテキスト保存 + pendingImageType設定 | ✅ 完了 |
| closeImageCaptionEditModal | pendingReplaceContextクリア追加 | ✅ 完了 |
| saveImageCaptionEdit (追加モード) | 画像置換時の処理追加 | ✅ 完了 |
| saveImageCaptionEdit (編集モード) | 一覧UI更新追加 | ✅ 完了 |

### 4. 相場ノート画像機能（2026-01-24）
| 修正箇所 | 内容 | 状態 |
|---------|------|------|
| updateImageCaption | tempNoteEditImages更新追加 | ✅ 完了 |
| updateImageCaption | サムネイルDOM更新追加 | ✅ 完了 |
| replaceNoteImage | 新規メソッド追加 | ✅ 完了 |
| collectNoteImages | tempNoteEditImagesから画像オブジェクト全体取得 | ✅ 完了 |

### 5. 画像コメントの改行・横幅問題（2026-01-25）✅ 完了

**症状**:
- スマホで画像のコメント（説明欄）を表示した際に横幅が狭い（129px）
- コメント枠の折り返しが多く段が増える

**原因**:
- `%`単位は親要素（画像幅257px）基準のため、画像が小さいとキャプションも縮小

**解決**: `vw`単位（ビューポート幅基準）に変更

| 修正箇所 | 修正前 | 修正後 |
|---------|--------|--------|
| 6_responsive.css 4545行目付近 | `max-width: 95%` | `max-width: 95vw` |
| 6_responsive.css 4545行目付近 | `width: 90%` | `width: 90vw` |

**結果**: キャプション幅 129px → 387px に改善

---

## 🔄 残課題

### 6. 週間プレビュー画像表示問題（保留）

**症状**:
- スマホから登録した画像が週間プレビュー（左側）に表示されない場合がある
- 右側の詳細パネルでは表示される
- 編集→保存後は表示される

**対応**: 問題発生時にデバッグコードで調査

**デバッグコード**: 要件定義書末尾に記載

---

## 📁 修正ファイル一覧

| ファイル | 修正内容 | 状態 |
|---------|---------|------|
| 6_responsive.css | 改行 + レスポンシブ + vw単位修正 | ✅ 完了 |
| imageHandler.js | PNG高画質化 | ✅ 完了 |
| script.js | トレード画像変更機能4箇所 | ✅ 完了 |
| NoteManagerModule.js | 相場ノート画像機能4箇所 | ✅ 完了 |

---

## 📊 進捗サマリー

```
CSS修正           ██████████ 100% ✅
画像圧縮設定       ██████████ 100% ✅
トレード画像変更   ██████████ 100% ✅
相場ノート画像     ██████████ 100% ✅
コメント改行横幅   ██████████ 100% ✅
週間プレビュー     ░░░░░░░░░░   保留（発生時デバッグ）
```

**全体進捗: 約95%**（週間プレビューは発生時対応のため保留扱い）

---

## 🔍 デバッグコード集

### 週間プレビュー調査用（問題発生時に使用）

```javascript
// ===== 週間プレビュー画像デバッグ =====
(function() {
    console.log('========================================');
    console.log('週間プレビュー画像 デバッグ開始');
    console.log('========================================');
    
    // 1. NoteManagerModule確認
    console.log('\n【1】NoteManagerModule確認');
    if (!window.NoteManagerModule) {
        console.log('❌ NoteManagerModuleが見つかりません');
        return;
    }
    console.log('✅ NoteManagerModule存在');
    
    // 2. 全ノートの画像確認
    console.log('\n【2】全ノートの画像確認');
    const allNotes = window.NoteManagerModule.getAllNotes();
    const notesWithImages = Object.entries(allNotes).filter(function(entry) {
        return entry[1].images && entry[1].images.length > 0;
    });
    console.log('画像ありノート数:', notesWithImages.length);
    
    notesWithImages.forEach(function(entry) {
        const dateStr = entry[0];
        const note = entry[1];
        console.log('\n  日付:', dateStr);
        note.images.forEach(function(img, i) {
            if (!img) {
                console.log('    画像' + (i+1) + ': null');
            } else if (typeof img === 'string') {
                console.log('    画像' + (i+1) + ': 文字列 -', img.substring(0, 40) + '...');
            } else {
                console.log('    画像' + (i+1) + ': オブジェクト');
                console.log('      url:', img.url ? img.url.substring(0, 40) + '...' : 'なし');
                console.log('      title:', img.title || 'なし');
            }
        });
    });
    
    // 3. DOM上のサムネイル確認
    console.log('\n【3】DOM上のサムネイル確認');
    var thumbs = document.querySelectorAll('.day-preview-thumb');
    console.log('サムネイル数:', thumbs.length);
    
    thumbs.forEach(function(thumb, i) {
        console.log('\n  サムネイル' + (i+1) + ':');
        console.log('    src:', thumb.src ? thumb.src.substring(0, 60) + '...' : 'なし');
        console.log('    表示:', thumb.offsetWidth > 0 ? '表示中 (' + thumb.offsetWidth + 'x' + thumb.offsetHeight + ')' : '非表示');
        console.log('    complete:', thumb.complete ? 'true' : 'false');
        console.log('    naturalWidth:', thumb.naturalWidth);
    });
    
    // 4. tempDayPreviewImages確認
    console.log('\n【4】tempDayPreviewImages確認');
    if (window.tempDayPreviewImages) {
        var keys = Object.keys(window.tempDayPreviewImages);
        console.log('キー数:', keys.length);
        keys.slice(0, 5).forEach(function(key) {
            var img = window.tempDayPreviewImages[key];
            console.log('  ' + key + ':', img ? (img.url ? 'URL形式' : 'その他') : 'null');
        });
        if (keys.length > 5) console.log('  ... 他' + (keys.length - 5) + '件');
    } else {
        console.log('未定義');
    }
    
    // 5. 週間プレビューコンテナ確認
    console.log('\n【5】週間プレビューコンテナ確認');
    var weekDays = document.getElementById('weekDays');
    if (weekDays) {
        var dayPreviews = weekDays.querySelectorAll('.day-preview');
        console.log('day-preview数:', dayPreviews.length);
        
        dayPreviews.forEach(function(day) {
            var dateEl = day.querySelector('.day-preview-date');
            var imagesDiv = day.querySelector('.day-preview-images');
            var thumbsInDay = day.querySelectorAll('.day-preview-thumb');
            
            if (thumbsInDay.length > 0 || imagesDiv) {
                console.log('\n  ' + (dateEl ? dateEl.textContent : '日付不明') + ':');
                console.log('    day-preview-images:', imagesDiv ? '存在' : 'なし');
                console.log('    サムネイル数:', thumbsInDay.length);
            }
        });
    } else {
        console.log('❌ weekDaysコンテナなし');
    }
    
    // 6. 画像読み込みエラー監視を設定
    console.log('\n【6】画像読み込みエラー監視を設定');
    thumbs.forEach(function(thumb, i) {
        thumb.onerror = function() {
            console.log('⚠️ 画像読み込みエラー: サムネイル' + (i+1));
            console.log('  src:', this.src);
        };
    });
    console.log('✅ エラー監視設定完了');
    
    console.log('\n========================================');
    console.log('デバッグ完了');
    console.log('========================================');
})();
```

---

## 📝 次回引継ぎ事項

1. **週間プレビュー画像表示問題**は発生時にデバッグコードで調査
2. 本機能は実質完了 - **REFERENCE.md** に完了履歴として記載可能

---

*更新日: 2026-01-25*

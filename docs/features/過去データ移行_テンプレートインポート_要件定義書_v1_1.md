# 過去データ移行（テンプレートインポート）要件定義書 v1.1

**作成日**: 2025-12-15  
**ステータス**: 📋 要件定義中  
**優先度**: 🔴 CRITICAL（リリース前実装）  
**実装時期**: Phase 1（2026年3月リリース）

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-12-15 | 初版作成 |
| v1.1 | 2025-12-15 | Pips自動計算、日付/時間分離、プルダウン追加、ロット任意化、お気に入り機能追加 |

---

## 1. 概要

### 1.1 目的

Excel/スプレッドシートで管理している既存トレーダーが、**過去データをTradingCompleteに移行**できるようにする。

### 1.2 背景・課題

```
【現在の課題】

ユーザー心理:
「TradingComplete良さそうだけど、
 今までのデータが見れなくなるなら今のままでいい」

→ 過去データの断絶 = 乗り換えの最大の障壁
```

### 1.3 過去の経緯

| 時期 | 機能 | 結果 |
|------|------|------|
| 以前 | ブローカーCSV直接取り込み | ❌ 形式が違いすぎて断念 |
| 2025-11-29 | 一括入力機能 | ❌ 統計整合性問題で削除 |
| 今回 | テンプレートインポート | ✅ 新規実装 |

### 1.4 解決策：テンプレート中間層戦略

```
【従来（断念）】

ブローカーA ─┐
ブローカーB ─┼─→ TradingComplete
ブローカーC ─┤    （各形式に対応必要）
自作Excel  ─┘    → 複雑すぎて断念 ❌


【今回の設計】

ブローカーA ─┐
ブローカーB ─┼─→ 📋 テンプレート ─→ TradingComplete
ブローカーC ─┤    （ユーザーが転記）   （1パターンだけ対応）
自作Excel  ─┘                        → シンプル！ ✅
```

---

## 2. ユーザー体験

### 2.1 ターゲットユーザー

- Excel/スプレッドシートでトレード記録を管理している人
- 他ツールからTradingCompleteへ乗り換えたい人
- 過去データを活かして分析したい人

### 2.2 ユーザー心理の変化

```
【Before（現在）】

「TradingComplete良さそう...」
         ↓
「でも今まで3年分のデータどうなる？」
         ↓
「見れなくなるなら今のExcelでいいや」
         ↓
離脱 ❌


【After（テンプレート実装後）】

「TradingComplete良さそう...」
         ↓
「過去データ？テンプレートに入れれば移行できるのか」
         ↓
「入力面倒だけど、1回だけだし...」
         ↓
「3年分の分析が全部見れるなら価値ある！」
         ↓
導入決定 ✅
```

### 2.3 ユーザーフロー

```
1. LP/ヘルプで案内
   「過去データを移行したい方は無料テンプレートをダウンロード」

2. テンプレートをダウンロード（Excel形式）

3. テンプレートに入力
   - 自作Excelからコピペ
   - ブローカーCSVから必要列だけコピペ
   - 手入力

4. TradingCompleteでインポート
   設定タブ → データ管理 → 「テンプレートからインポート」
   → .xlsx または .csv をアップロード

5. 完了！
   過去トレードが全て反映、統計も全部使える
```

---

## 3. テンプレート設計

### 3.1 配布形式

| 項目 | 内容 |
|------|------|
| ファイル形式 | Excel（.xlsx） |
| 配布数 | 1つ |
| 読み込み対応 | .xlsx / .csv 両方 |

### 3.2 Excelシート構成

```
【シート構成】

Sheet 1: トレード入力（メイン）
├─ 必須・任意列
├─ 通貨ペア: お気に入りからプルダウン選択
├─ ブローカー: お気に入りからプルダウン選択 or 直接入力
└─ Pips: 数式で自動計算

Sheet 2: お気に入り設定
├─ お気に入り通貨ペア（最大10個）← 53種から選んで登録
└─ お気に入りブローカー（最大10個）← 13社から選んで登録

Sheet 3: マスターデータ（非表示推奨）
├─ 53通貨ペアリスト（Sheet2のプルダウン用）
└─ 13ブローカーリスト（Sheet2のプルダウン用）
```

**ポイント**: ユーザーは最初にSheet2でお気に入りを設定 → Sheet1で快適に入力

### 3.3 列定義

#### 必須列（7項目）

| # | 列名 | 型 | 入力方法 | 説明 | 例 |
|---|------|-----|----------|------|-----|
| 1 | エントリー日付 | date | 手入力 | 取引開始日 | 2024-01-15 |
| 2 | エントリー時間 | time | 手入力（任意） | 取引開始時間 | 09:30 |
| 3 | 決済日付 | date | 手入力 | 取引終了日 | 2024-01-15 |
| 4 | 決済時間 | time | 手入力（任意） | 取引終了時間 | 14:45 |
| 5 | 通貨ペア | text | **プルダウン** | 53種＋お気に入り | USD/JPY |
| 6 | 売買方向 | text | **プルダウン** | ロング/ショート | ロング |
| 7 | エントリー価格 | number | 手入力 | 開始価格 | 148.500 |
| 8 | 決済価格 | number | 手入力 | 終了価格 | 149.200 |
| 9 | 純損益（円） | number | 手入力 | 最終損益 | 7000 |

**※ Pipsは自動計算（通貨ペアとエントリー/決済価格から算出）**

#### 任意列（7項目）

| # | 列名 | 型 | 入力方法 | デフォルト |
|---|------|-----|----------|-----------|
| 10 | ロット数 | number | 手入力 | 空欄（「未記入」バッジ表示） |
| 11 | スワップ（円） | number | 手入力 | 0 |
| 12 | 手数料（円） | number | 手入力 | 0 |
| 13 | ブローカー | text | **プルダウン**＋直接入力 | 空欄 |
| 14 | SL価格 | number | 手入力 | 空欄 |
| 15 | TP価格 | number | 手入力 | 空欄 |
| 16 | メモ | text | 手入力 | 空欄 |

### 3.4 プルダウン仕様

#### 通貨ペアプルダウン（Sheet 1）

```
【トレード入力シートのプルダウン】

┌─────────────────────────┐
│   USD/JPY               │  ← お気に入りに
│   EUR/USD               │    登録したものだけ表示
│   GBP/JPY               │
│   EUR/JPY               │
│   AUD/USD               │
│   （登録した分だけ）      │
└─────────────────────────┘

※ 53種全部は表示しない（選びやすさ優先）
※ 53種はSheet2でお気に入り登録時のみ使用
```

**53通貨ペアリスト**: TradingCompleteのPRESET_CURRENCY_PAIRSと同一（Sheet3に格納）

#### 売買方向プルダウン

```
┌─────────────────────────┐
│   ロング                │
│   ショート              │
└─────────────────────────┘
```

#### ブローカープルダウン（Sheet 1）

```
【トレード入力シートのプルダウン】

┌─────────────────────────┐
│   DMM FX                │  ← お気に入りに
│   GMOクリック証券        │    登録したものだけ表示
│   XM Trading            │
│   （登録した分だけ）      │
├─────────────────────────┤
│ （直接入力も可）         │  ← プルダウンにない場合
└─────────────────────────┘

※ 13社全部は表示しない（選びやすさ優先）
※ 13社はSheet2でお気に入り登録時のみ使用
※ お気に入りにないブローカーは直接入力可能
```

**13ブローカーリスト**: TradingCompleteのPRESET_BROKERSと同一（Sheet3に格納）

```
【プリセット13社】

国内（9社）:
├─ DMM FX
├─ GMOクリック証券
├─ 外為どっとコム
├─ みんなのFX
├─ LIGHT FX
├─ SBI FXトレード
├─ 楽天FX
├─ 松井証券 MATSUI FX
└─ ヒロセ通商 LION FX

海外（4社）:
├─ XM Trading
├─ AXIORY
├─ Exness
└─ TitanFX
```

### 3.5 お気に入り設定シート（Sheet 2）

```
【お気に入り設定の使い方】

Step 1: このシートで53種から選んでお気に入り登録
Step 2: トレード入力シートのプルダウンに反映される


┌─────────────────────────────────────────┐
│ ⭐ お気に入り通貨ペア（最大10個）        │
│                                         │
│ ※ 下のプルダウンから選んで登録してください │
│ ※ 登録した通貨ペアがSheet1で選べます    │
├─────────────────────────────────────────┤
│ 1. [プルダウン: 53種から選択]           │
│ 2. [プルダウン: 53種から選択]           │
│ ...                                     │
│ 10. [プルダウン: 53種から選択]          │
├─────────────────────────────────────────┤
│ ⭐ お気に入りブローカー（最大10個）      │
│                                         │
│ ※ 下のプルダウンから選んで登録してください │
│ ※ 登録したブローカーがSheet1で選べます  │
├─────────────────────────────────────────┤
│ 1. [プルダウン: 13社から選択]           │
│ 2. [プルダウン: 13社から選択]           │
│ ...                                     │
│ 10. [プルダウン: 13社から選択]          │
└─────────────────────────────────────────┘
```

### 3.6 Pips自動計算ロジック

```javascript
// Excelの数式またはインポート時に計算

function calculatePips(pair, entryPrice, exitPrice, direction) {
    // JPYペアは小数点2桁、その他は小数点4桁
    const isJPYPair = pair.includes('JPY') || pair.includes('XAU');
    const pipMultiplier = isJPYPair ? 100 : 10000;
    
    let pips;
    if (direction === 'ロング' || direction === 'long' || direction === 'Buy') {
        pips = (exitPrice - entryPrice) * pipMultiplier;
    } else {
        pips = (entryPrice - exitPrice) * pipMultiplier;
    }
    
    return Math.round(pips * 10) / 10; // 小数点1桁
}
```

**Excelでの数式例**:
```
=IF(OR(ISNUMBER(SEARCH("JPY",C2)),ISNUMBER(SEARCH("XAU",C2))),
    IF(D2="ロング",(F2-E2)*100,(E2-F2)*100),
    IF(D2="ロング",(F2-E2)*10000,(E2-F2)*10000))
```

### 3.7 損益入力の柔軟性

```
【パターンA】純損益だけ入力（多数派想定）

純損益: +15,000円 ← 手数料・スワップ込みの最終金額
スワップ: （空欄）
手数料: （空欄）

→ 内部で スワップ=0, 手数料=0 として処理


【パターンB】分けて入力（詳細管理派）

純損益: +15,000円
スワップ: +200円
手数料: -1,200円

→ すべて記録される
```

### 3.8 勝敗判定ルール

```
【現状維持：統計ごとに異なる判定】

Pips統計での勝敗:
├─ pips >= 0 → 勝ち
└─ pips < 0  → 負け

円建て統計での勝敗:
├─ netProfit > 0 → 勝ち
└─ netProfit <= 0 → 負け

【スワップ負けの例】
Pips: +10（価格差で勝ち）
スワップ: -5,000円
純損益: -2,000円

→ Pips統計: 勝ち
→ 円建て統計: 負け
```

### 3.9 取り込まない項目（空欄として登録）

過去データには存在しない項目：

| 項目 | 取り込み後 |
|------|-----------|
| チェックリスト（理由1〜3） | 空欄 |
| シナリオ | 空欄 |
| 感情記録 | 空欄 |
| チャート画像（3枚） | なし |
| 振り返り | 空欄 |

→ **後から個別に追記可能**

---

## 4. UI設計

### 4.1 配置場所

```
設定タブ
└─ データ管理
   ├─ エクスポート（JSON）
   ├─ インポート（JSON）
   ├─ 📥 テンプレートからインポート  ← 新規追加
   │   ├─ [テンプレートをダウンロード]
   │   └─ [ファイルを選択してインポート]
   └─ データ削除
```

### 4.2 UI案

```
┌─────────────────────────────────────────────────────┐
│ 📥 過去データのインポート                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│ Excel/スプレッドシートの過去データを                  │
│ TradingCompleteに取り込めます。                      │
│                                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ Step 1: テンプレートをダウンロード               │ │
│ │                                                 │ │
│ │ [📄 テンプレートをダウンロード]                  │ │
│ │                                                 │ │
│ │ ※Excelまたはスプレッドシートで開いて            │ │
│ │  過去のトレードデータを入力してください          │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ Step 2: 入力済みファイルをインポート             │ │
│ │                                                 │ │
│ │ [ファイルを選択] .xlsx / .csv 対応              │ │
│ │                                                 │ │
│ │ [インポート実行]                                │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ ⚠️ 注意事項                                        │
│ ・必須列がすべて入力されているか確認してください     │
│ ・重複チェックは行われません                        │
│ ・インポート前にバックアップを推奨します             │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 4.3 インポート結果画面

```
┌─────────────────────────────────────────────────────┐
│ ✅ インポート完了                                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 取り込み結果:                                       │
│ ├─ 成功: 156件                                     │
│ ├─ スキップ: 3件（必須項目不足）                    │
│ └─ エラー: 0件                                     │
│                                                     │
│ [詳細を確認] [トレード記録を見る] [閉じる]          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 5. 技術仕様

### 5.1 使用ライブラリ

| ライブラリ | 用途 | 備考 |
|-----------|------|------|
| SheetJS (xlsx) | Excel読み込み | CDN利用可 |

```html
<!-- index.html に追加 -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
```

### 5.2 モジュール設計

```
js/
└─ part5_settings/
   └─ TemplateImportModule.js  ← 新規作成
```

#### Public API

```javascript
class TemplateImportModule {
    // 初期化
    static init()
    
    // テンプレートダウンロード
    static downloadTemplate()
    
    // ファイルインポート（xlsx/csv対応）
    static async importFile(file)
    
    // バリデーション
    static validateData(rows)
    
    // トレードデータに変換
    static convertToTrades(validRows)
}
```

### 5.3 データ変換フロー

```
1. ファイル読み込み
   └─ .xlsx → SheetJSでパース
   └─ .csv → Papa Parse or 手動パース

2. ヘッダー検証
   └─ 必須列が存在するか確認

3. 行ごとにバリデーション
   └─ 必須項目が入力されているか
   └─ 数値型の検証
   └─ 日時フォーマットの検証

4. トレードデータ形式に変換
   └─ TradingCompleteの内部形式に合わせる
   └─ ID生成（import_timestamp_index形式）

5. LocalStorageに保存
   └─ 既存tradesに追加

6. UI更新
   └─ トレード一覧更新
   └─ 統計更新
```

### 5.4 データ変換マッピング

```javascript
// テンプレート列 → TradingComplete内部形式

{
    id: `import_${Date.now()}_${index}`,
    
    // 必須（日付と時間を結合）
    date: combineDateTime(row['エントリー日付'], row['エントリー時間']),
    exitDate: combineDateTime(row['決済日付'], row['決済時間']),
    pair: row['通貨ペア'],
    direction: normalizeDirection(row['売買方向']),
    entryPrice: parseFloat(row['エントリー価格']),
    exitPrice: parseFloat(row['決済価格']),
    
    // Pips自動計算
    pips: calculatePips(
        row['通貨ペア'],
        parseFloat(row['エントリー価格']),
        parseFloat(row['決済価格']),
        row['売買方向']
    ),
    
    // 円建て損益
    yenProfitLoss: parseFloat(row['純損益（円）']),
    yenSwap: parseFloat(row['スワップ（円）']) || 0,
    yenCommission: parseFloat(row['手数料（円）']) || 0,
    
    // 任意（ロットは空の場合null）
    lots: row['ロット数'] ? parseFloat(row['ロット数']) : null,
    broker: row['ブローカー'] || '',
    stopLoss: parseFloat(row['SL価格']) || null,
    takeProfit: parseFloat(row['TP価格']) || null,
    memo: row['メモ'] || '',
    
    // 空欄として登録
    checklist: { reason1: '', reason2: '', reason3: '' },
    scenario: '',
    emotion: '',
    images: [],
    reflection: {},
    
    // メタデータ
    isImported: true,  // インポートデータフラグ
    importedAt: new Date().toISOString(),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
}

// 日付と時間の結合
function combineDateTime(dateStr, timeStr) {
    if (!dateStr) return null;
    if (!timeStr) return dateStr; // 時間なしの場合は日付のみ
    return `${dateStr} ${timeStr}`;
}
```

### 5.5 売買方向の正規化

```javascript
function normalizeDirection(value) {
    const normalized = String(value).toLowerCase().trim();
    
    // ロング判定
    if (['buy', 'long', 'ロング', '買', '買い'].includes(normalized)) {
        return 'long';
    }
    
    // ショート判定
    if (['sell', 'short', 'ショート', '売', '売り'].includes(normalized)) {
        return 'short';
    }
    
    return null; // バリデーションエラー
}
```

---

## 6. バリデーション

### 6.1 必須項目チェック

| 列 | チェック内容 |
|-----|-------------|
| エントリー日付 | 空でない、日付形式 |
| 決済日付 | 空でない、日付形式 |
| 通貨ペア | 空でない、53種のいずれか |
| 売買方向 | ロング/ショート/Buy/Sell等 |
| エントリー価格 | 数値、0より大きい |
| 決済価格 | 数値、0より大きい |
| 純損益（円） | 数値 |

### 6.2 任意項目チェック

| 列 | チェック内容 |
|-----|-------------|
| エントリー時間 | 空OK、入力時は時間形式 |
| 決済時間 | 空OK、入力時は時間形式 |
| ロット数 | 空OK、入力時は数値・0より大きい |
| スワップ（円） | 空OK、入力時は数値 |
| 手数料（円） | 空OK、入力時は数値 |
| ブローカー | 空OK |
| SL/TP価格 | 空OK、入力時は数値 |

### 6.3 Pips自動計算の検証

```javascript
// インポート時に自動計算
const calculatedPips = calculatePips(pair, entryPrice, exitPrice, direction);

// 計算結果の妥当性チェック（警告のみ、エラーにはしない）
if (Math.abs(calculatedPips) > 1000) {
    warnings.push(`行${row}: Pipsが${calculatedPips}と大きい値です。価格を確認してください`);
}
```

### 6.2 エラーハンドリング

```javascript
// バリデーション結果
{
    valid: [...],      // 取り込みOKな行
    invalid: [         // エラー行
        { row: 5, errors: ['Pipsが空です', 'ロット数が数値ではありません'] },
        { row: 12, errors: ['売買方向が不正です'] }
    ]
}
```

### 6.3 エラー表示

```
⚠️ 3件のデータをスキップしました

行5: Pipsが空です、ロット数が数値ではありません
行12: 売買方向が不正です
行23: エントリー日時の形式が不正です

[スキップして続行] [キャンセル]
```

---

## 7. 実装フェーズ

### Phase 1: 基本実装

| # | タスク | 工数目安 |
|---|--------|---------|
| 1 | テンプレートExcel作成（3シート構成） | 2h |
| 2 | SheetJSライブラリ追加 | 0.5h |
| 3 | TemplateImportModule.js作成 | 4h |
| 4 | Pips自動計算ロジック | 1h |
| 5 | UI実装（設定タブ内） | 2h |
| 6 | バリデーション実装 | 2h |
| 7 | テスト | 2h |
| **合計** | | **約14h** |

### Phase 2: 改善（リリース後）

- エラー行の詳細表示
- プレビュー機能
- 重複チェック機能
- undo機能（一括削除）

---

## 8. テスト項目

### 8.1 正常系

| # | テスト | 期待結果 |
|---|--------|---------|
| 1 | 必須項目のみ入力してインポート | 成功、任意項目は空/0/null |
| 2 | 全項目入力してインポート | 成功、全項目反映 |
| 3 | .xlsxファイルでインポート | 成功 |
| 4 | .csvファイルでインポート | 成功 |
| 5 | 100件のデータをインポート | 成功、統計反映 |
| 6 | 売買方向「Buy」「ロング」「買い」 | すべて「long」に正規化 |
| 7 | 日付のみ（時間なし）でインポート | 成功、時間は空として処理 |
| 8 | ロット未入力でインポート | 成功、一覧で「未記入」バッジ表示 |
| 9 | Pips自動計算（USD/JPY） | 正しく計算（小数点2桁） |
| 10 | Pips自動計算（EUR/USD） | 正しく計算（小数点4桁） |
| 11 | お気に入り通貨ペアからの選択 | Sheet2で登録した通貨ペアがSheet1で選択可能 |
| 12 | お気に入りブローカーからの選択 | Sheet2で登録したブローカーがSheet1で選択可能 |
| 13 | ブローカー直接入力 | プルダウンにないブローカー名を直接入力可能 |

### 8.2 異常系

| # | テスト | 期待結果 |
|---|--------|---------|
| 1 | 必須列が欠けている | エラー表示、該当行スキップ |
| 2 | 数値列に文字列 | エラー表示、該当行スキップ |
| 3 | 空のファイル | エラーメッセージ |
| 4 | 非対応形式（.pdf等） | エラーメッセージ |
| 5 | 日付形式が不正 | エラー表示、該当行スキップ |
| 6 | 通貨ペアがプリセットにない | エラー表示、該当行スキップ |
| 7 | 売買方向が不正な値 | エラー表示、該当行スキップ |

### 8.3 統計確認

| # | 確認項目 |
|---|---------|
| 1 | インポート後、分析タブの統計が正しく更新される |
| 2 | Pips統計が正確に計算される（自動計算値） |
| 3 | 円建て統計が正確に計算される |
| 4 | 勝率が正確に計算される（Pips/円建て両方） |
| 5 | 月別・年別レポートに反映される |
| 6 | ロット未入力データが統計に影響しない |

### 8.4 お気に入り機能確認

| # | 確認項目 |
|---|---------|
| 1 | Sheet2で登録した通貨ペアがSheet1のプルダウンに表示される |
| 2 | Sheet2で登録したブローカーがSheet1のプルダウンに表示される |
| 3 | Sheet2で53種から通貨ペアを選んで登録できる |
| 4 | Sheet2で13社からブローカーを選んで登録できる |
| 5 | お気に入りが空の場合、Sheet1のプルダウンは空（エラーにならない） |
| 6 | ブローカーは直接入力も可能 |

---

## 9. マーケティング活用

### 9.1 訴求ポイント

```
「過去のトレード記録、捨てなくて大丈夫です」

✅ Excel/スプレッドシートからカンタン移行
✅ 無料テンプレートで入力するだけ
✅ 過去データも含めた統計分析が可能に
```

### 9.2 LP・ヘルプでの案内

```
【こんな方におすすめ】
・Excelでトレード記録を付けている方
・過去のデータを活かして分析したい方
・乗り換えでデータを失いたくない方

【移行の流れ】
1. 無料テンプレートをダウンロード
2. 過去のトレードデータを入力
3. TradingCompleteにインポート
4. 完了！過去データも含めた分析が可能に
```

---

## 10. 関連ドキュメント

| ドキュメント | 役割 |
|-------------|------|
| [一括入力機能削除_要件定義書_v1_3_最終版.md](./一括入力機能削除_要件定義書_v1_3_最終版.md) | 一括入力削除の経緯 |
| [MODULES.md](./MODULES.md) | モジュール技術仕様 |
| [TASKS.md](./TASKS.md) | タスク管理 |

---

## 11. 今後の検討事項

### 11.1 Phase 2以降で検討

| 機能 | 説明 |
|------|------|
| ブローカー別変換ツール | 主要ブローカーCSV→テンプレート変換 |
| 列マッピングUI | ユーザーが「この列=日付」と指定 |
| MT4/MT5連携 | 取引履歴の自動取り込み |
| 重複検出 | 同一トレードの二重登録防止 |

### 11.2 オープンな質問

- インポートデータの識別（isImported フラグ）は統計表示で区別するか？
- 大量データ（1000件以上）のパフォーマンス検証は必要か？

---

**ステータス: 📋 要件定義完了 → 実装待ち**

*このドキュメントは実装フェーズで更新されます*

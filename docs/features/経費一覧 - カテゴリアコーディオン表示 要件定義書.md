# 経費一覧 - カテゴリアコーディオン表示 要件定義書

**作成日**: 2025-11-11  
**バージョン**: 1.0  
**対象機能**: 収支管理タブ > 経費一覧  
**優先度**: HIGH  
**所要時間**: 2-3時間

---

## 1. 目的・背景

### 1.1 現状の問題点
- 経費がフラットに一覧表示され、視認性が低い
- スクロールが長く、目的の経費を探しにくい
- カテゴリ別の集計がひと目でわからない
- 確定申告時に必要な「カテゴリ別集計」が見づらい

### 1.2 改善の目的
- **視認性向上**: カテゴリごとにグループ化し、見やすくする
- **実用性向上**: 税務・会計で必要なカテゴリ別集計を一目で把握
- **操作性向上**: アコーディオンで必要な情報だけ表示
- **UX改善**: カード形式で現代的で洗練されたデザイン

---

## 2. 機能要件

### 2.1 カテゴリグループ化

#### 2.1.1 グループ化ルール
- フィルター適用後の経費データを**カテゴリごと**にグループ化
- カテゴリの並び順: 
  - ExpenseManagerModuleの`#categories`配列の順序を使用（固定順）
  - 理由: 毎月同じ順序で表示することで、視認性・予測可能性・使いやすさを向上
  - 順序: 通信・インフラ → 機器・設備 → 情報・学習 → ツール・ソフト → 手数料・その他
- 経費が0件のカテゴリは表示しない

**カテゴリ表示順序（固定）:**
```
1. 通信・インフラ
   - 通信費（ネット代）
   - VPS・クラウドサービス
   - 電気代（按分）
   - 家賃（按分）

2. 機器・設備
   - PC・モニター（10万円未満）
   - PC周辺機器
   - デスク・チェア
   - 事務用品

3. 情報・学習
   - 書籍・教材費
   - セミナー参加費
   - オンラインサロン会費
   - 有料情報配信サービス
   - 経済新聞・雑誌購読料

4. ツール・ソフト
   - 取引ツール・ソフト
   - EA・インジケーター
   - セキュリティソフト

5. 手数料・その他
   - 取引手数料
   - 振込手数料
   - 税理士・会計士報酬
   - FX関連交通費
   - 会議費（情報交換）
   - その他
```

#### 2.1.2 カテゴリサマリー
各カテゴリヘッダーに以下を表示:
- カテゴリ名（アイコン付き）
- 件数
- 合計金額（円）
- 展開/折りたたみアイコン

**表示例:**
```
📂 通信費（ネット代）              [▼]
   12件 / 合計: ¥60,000
```

### 2.2 アコーディオン機能

#### 2.2.1 展開/折りたたみ
- カテゴリヘッダーをクリック → トグル（展開⇔折りたたみ）
- 初期状態: すべて折りたたみ
- アニメーション: スムーズな開閉（0.3秒）
- アイコン: 
  - 折りたたみ時: ▶
  - 展開時: ▼

#### 2.2.2 状態保持
- ページ遷移後も展開状態を保持（LocalStorage使用）
- キー: `tc_expense_accordion_state`
- 値: `{ "通信費（ネット代）": true, "VPS": false, ... }`

### 2.3 カード形式表示

#### 2.3.1 カードレイアウト
各経費を1枚のカードとして表示:

```
┌─────────────────────────────────────┐
│ 📅 2025-11-11          💰 ¥5,000   │
│ 📝 光回線月額                       │
│                          [🗑️ 削除] │
└─────────────────────────────────────┘
```

**表示項目:**
- 日付（左上）
- 金額（右上、強調）
- 説明/メモ（左下）
- 削除ボタン（右下）

#### 2.3.2 カードスタイル
- 背景色: 
  - デフォルト: `#2a2a2a`（ダークテーマ）
  - ホバー時: `#3a3a3a`
- ボーダー: `1px solid #444`
- 角丸: `8px`
- 余白: `padding: 12px`
- シャドウ: ホバー時に薄いシャドウ

#### 2.3.3 カード内ソート
カテゴリ内の経費は、選択した並び順でソート:
- 日付順（新しい順 / 古い順）
- 金額順（高い順 / 低い順）

### 2.4 フィルター連携

#### 2.4.1 フィルター適用フロー
1. ユーザーがフィルター変更
2. `getExpensesByFilter()` でデータ取得
3. カテゴリごとにグループ化
4. アコーディオン形式で表示

#### 2.4.2 特殊ケース: カテゴリフィルター
- フィルターで特定カテゴリを選択した場合
- そのカテゴリのみ表示
- アコーディオンヘッダーは表示（件数・合計表示のため）
- デフォルトで展開状態

### 2.5 全体サマリー

表示領域の最下部に全体集計を表示:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
総件数: 107件 / 総額: ¥854,662
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 3. UI/UX要件

### 3.1 レスポンシブ対応

#### 3.1.1 デスクトップ（>1200px）
- カードは横幅100%
- 日付と金額を横並び

#### 3.1.2 タブレット（768px - 1200px）
- カードは横幅100%
- 日付と金額を横並び

#### 3.1.3 モバイル（<768px）
- カードは横幅100%
- 日付と金額を縦積み

### 3.2 アクセシビリティ

- カテゴリヘッダー: `role="button"` `aria-expanded="true/false"`
- キーボード操作: Enterキーで展開/折りたたみ
- カラーコントラスト: WCAG AA準拠

### 3.3 パフォーマンス

- 経費100件以下: 即座に表示（<100ms）
- 経費100-500件: 1秒以内
- 経費500件以上: 仮想スクロール検討（将来）

---

## 4. 技術要件

### 4.1 修正対象ファイル

**ExpenseManagerModule.js**
- `updateExpenseListFull()` メソッドを全面改修
- 新規メソッド追加:
  - `#groupExpensesByCategory(expenses)` - カテゴリグループ化（`#categories`配列の順序を使用）
  - `#generateCategoryHTML(category, expenses)` - カテゴリHTML生成
  - `#generateExpenseCardHTML(expense)` - カードHTML生成
  - `#toggleCategory(categoryName)` - アコーディオン開閉
  - `#loadAccordionState()` - 状態読み込み
  - `#saveAccordionState(state)` - 状態保存

**グループ化ロジック:**
```javascript
#groupExpensesByCategory(expenses) {
    const grouped = {};
    
    // #categories配列の順序でグループ化（固定順）
    this.#categories.forEach(category => {
        grouped[category] = [];
    });
    
    // 経費を該当カテゴリに振り分け
    expenses.forEach(expense => {
        if (grouped[expense.category]) {
            grouped[expense.category].push(expense);
        }
    });
    
    // 経費0件のカテゴリは除外
    Object.keys(grouped).forEach(category => {
        if (grouped[category].length === 0) {
            delete grouped[category];
        }
    });
    
    return grouped;
}
```

### 4.2 データ構造

#### 4.2.1 グループ化後のデータ
```javascript
{
  "通信費（ネット代）": [
    { id: "xxx", date: "2025-11-11", amount: 5000, ... },
    { id: "yyy", date: "2025-10-11", amount: 5000, ... }
  ],
  "VPS・クラウドサービス": [
    { id: "zzz", date: "2025-11-01", amount: 12000, ... }
  ]
}
```

#### 4.2.2 アコーディオン状態
```javascript
{
  "通信費（ネット代）": true,    // 展開
  "VPS・クラウドサービス": false  // 折りたたみ
}
```

### 4.3 LocalStorage

**キー**: `tc_expense_accordion_state`  
**値**: JSON文字列  
**更新タイミング**: カテゴリ展開/折りたたみ時

### 4.4 EventBus連携

既存のEventBusイベントを維持:
- `expenses:filtered` - フィルター変更時
- `expense:added` - 経費追加時（表示更新）
- `expense:deleted` - 経費削除時（表示更新）

---

## 5. HTML/CSS仕様

### 5.1 HTML構造

```html
<div id="expenseListFull">
  <!-- カテゴリ1 -->
  <div class="expense-category-group">
    <div class="category-header" onclick="toggleCategory('通信費（ネット代）')">
      <div class="category-info">
        <span class="category-icon">📂</span>
        <span class="category-name">通信費（ネット代）</span>
      </div>
      <div class="category-summary">
        <span class="category-count">12件</span>
        <span class="category-total">¥60,000</span>
        <span class="toggle-icon">▼</span>
      </div>
    </div>
    <div class="category-content" data-category="通信費（ネット代）">
      <!-- カード1 -->
      <div class="expense-card">
        <div class="card-header">
          <span class="card-date">📅 2025-11-11</span>
          <span class="card-amount">💰 ¥5,000</span>
        </div>
        <div class="card-body">
          <span class="card-description">📝 光回線月額</span>
        </div>
        <div class="card-footer">
          <button class="btn-delete" onclick="window.ExpenseManagerModule.deleteExpenseWithConfirm('xxx')">
            🗑️ 削除
          </button>
        </div>
      </div>
      <!-- カード2... -->
    </div>
  </div>
  
  <!-- カテゴリ2... -->
  
  <!-- 全体サマリー -->
  <div class="expense-total-summary">
    総件数: 107件 / 総額: ¥854,662
  </div>
</div>
```

### 5.2 CSS仕様

```css
/* カテゴリグループ */
.expense-category-group {
  margin-bottom: 20px;
  border: 1px solid #444;
  border-radius: 8px;
  overflow: hidden;
}

/* カテゴリヘッダー */
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: #2a2a2a;
  cursor: pointer;
  transition: background 0.2s;
}

.category-header:hover {
  background: #3a3a3a;
}

/* カテゴリ情報 */
.category-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.category-name {
  font-size: 16px;
  font-weight: 500;
}

/* カテゴリサマリー */
.category-summary {
  display: flex;
  align-items: center;
  gap: 15px;
}

.category-count {
  color: #aaa;
  font-size: 14px;
}

.category-total {
  font-weight: bold;
  font-size: 16px;
  color: #4CAF50;
}

.toggle-icon {
  font-size: 12px;
  transition: transform 0.3s;
}

/* 折りたたみ時 */
.category-header[aria-expanded="false"] .toggle-icon {
  transform: rotate(-90deg);
}

/* カテゴリコンテンツ */
.category-content {
  padding: 10px;
  background: #1a1a1a;
  display: none; /* 初期は非表示 */
}

.category-content.expanded {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
  }
  to {
    opacity: 1;
    max-height: 2000px;
  }
}

/* 経費カード */
.expense-card {
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.expense-card:hover {
  background: #3a3a3a;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.card-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.card-date {
  color: #aaa;
  font-size: 14px;
}

.card-amount {
  font-weight: bold;
  font-size: 16px;
  color: #4CAF50;
}

.card-body {
  margin-bottom: 8px;
  color: #ccc;
}

.card-footer {
  display: flex;
  justify-content: flex-end;
}

.btn-delete {
  padding: 4px 12px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.btn-delete:hover {
  background: #c82333;
}

/* 全体サマリー */
.expense-total-summary {
  margin-top: 30px;
  padding: 15px;
  text-align: center;
  font-size: 16px;
  font-weight: bold;
  border-top: 2px solid #444;
  color: #ccc;
}
```

---

## 6. 制約事項・前提条件

### 6.1 前提条件
- ExpenseManagerModule.jsが正常に動作している
- 既存のフィルター機能が実装済み
- LocalStorageが使用可能

### 6.2 制約事項
- 既存のデータ構造は変更しない
- 既存のフィルター機能は維持
- 既存のEventBus連携は維持
- Internet Explorer非対応（モダンブラウザのみ）

### 6.3 互換性
- 既存の削除機能は維持（`deleteExpenseWithConfirm()`）
- 既存のイベント発火は維持
- 既存のLocalStorageキーと競合しない

---

## 7. 期待される効果

### 7.1 定量的効果
- 経費検索時間: 50%削減（目測）
- スクロール量: 70%削減
- 確定申告準備時間: 30%削減

### 7.2 定性的効果
- ✅ 視認性の大幅向上
- ✅ 税務・会計実務での利便性向上
- ✅ モダンで洗練されたUI
- ✅ ユーザー満足度向上
- ✅ 毎月同じ順序で表示 → 予測可能性・使いやすさ向上
- ✅ カテゴリグループが固定 → 学習コストなし、ストレスフリー

---

## 8. テスト項目

### 8.1 機能テスト

#### 8.1.1 グループ化
- [ ] 経費が正しくカテゴリごとにグループ化される
- [ ] カテゴリの並び順が`#categories`配列の順序と一致する（固定順）
- [ ] カテゴリの表示順序が毎月同じである
- [ ] 経費0件のカテゴリは表示されない

#### 8.1.2 アコーディオン
- [ ] カテゴリヘッダークリックで展開/折りたたみ
- [ ] 初期状態: すべて折りたたみ
- [ ] アイコンが正しく切り替わる（▶ ⇔ ▼）
- [ ] アニメーションがスムーズ

#### 8.1.3 状態保持
- [ ] 展開状態がLocalStorageに保存される
- [ ] ページリロード後も状態が復元される
- [ ] タブ切り替え後も状態が保持される

#### 8.1.4 カード表示
- [ ] 各経費が正しくカード形式で表示される
- [ ] 日付・金額・説明・削除ボタンが正しく表示
- [ ] ホバー時のスタイルが適用される

#### 8.1.5 削除機能
- [ ] 削除ボタンをクリックで確認ダイアログ表示
- [ ] 削除成功時、カードが消える
- [ ] 削除後、カテゴリサマリーが更新される
- [ ] カテゴリ内の経費が0件になった場合、カテゴリごと非表示

### 8.2 フィルター連携テスト

- [ ] 年度フィルター変更で表示が更新される
- [ ] 月フィルター変更で表示が更新される
- [ ] カテゴリフィルター選択で該当カテゴリのみ表示
- [ ] 並び替え選択でカテゴリ内の順序が変わる
- [ ] フィルターリセットで全経費が表示される

### 8.3 エッジケーステスト

- [ ] 経費0件の場合: 「経費データがありません」表示
- [ ] 経費1件の場合: 正常に表示
- [ ] 経費100件以上の場合: パフォーマンス確認
- [ ] カテゴリ1つに経費100件以上: スクロール確認
- [ ] 全カテゴリ展開時のレンダリング速度

### 8.4 レスポンシブテスト

- [ ] デスクトップ表示が正常
- [ ] タブレット表示が正常
- [ ] モバイル表示が正常
- [ ] ウィンドウサイズ変更時のレイアウト

### 8.5 統合テスト

- [ ] 経費追加後、表示が自動更新される
- [ ] サマリー自動更新機能と連携
- [ ] EventBusイベントが正しく発火

---

## 9. 実装スケジュール

### Phase 1: コア機能実装（1.5時間）
- グループ化ロジック
- アコーディオン機能
- カード表示

### Phase 2: 状態保持・細部調整（1時間）
- LocalStorage連携
- CSS調整
- アニメーション

### Phase 3: テスト・デバッグ（0.5時間）
- 機能テスト
- エッジケーステスト
- バグ修正

**合計所要時間**: 2-3時間

---

## 10. 成果物

### 10.1 修正ファイル
- `ExpenseManagerModule.js` （updateExpenseListFull メソッド全面改修）

### 10.2 ドキュメント
- TASKS.md更新（完了記録）
- REFERENCE.md更新（実装パターン記録）

---

## 11. 承認

### 要件確認チェックリスト
- [ ] カテゴリアコーディオン表示で問題ないか
- [ ] カテゴリの並び順は固定順（`#categories`配列順）で問題ないか
- [ ] カード形式デザインで問題ないか
- [ ] 初期状態「すべて折りたたみ」で問題ないか
- [ ] フィルター機能の維持で問題ないか
- [ ] 状態保持機能が必要か

**承認者**: コンパナ  
**承認日**: 2025-11-11

---

*この要件定義書は、実装前に内容を確認・調整し、承認を得てから作業を開始します。*
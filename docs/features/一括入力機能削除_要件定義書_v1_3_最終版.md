# 一括入力機能削除 要件定義書 v1.3（最終版）

**作成日**: 2025-11-28  
**最終更新**: 2025-11-29  
**ステータス**: ✅ **完了**  
**優先度**: 🔴 CRITICAL  

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-11-28 | 初版作成 |
| v1.1 | 2025-11-29 | isBulkEntry使用箇所の追加調査反映 |
| v1.2 | 2025-11-29 | 別チャット修正指示対応、慎重な進行方針追加 |
| **v1.3** | **2025-11-29** | **作業完了、実績反映、最終版** |

---

## 1. 概要

### 1.1 目的

Phase 1リリース（2026年3月）に向けて、一括入力機能を**完全削除**し、システムをシンプル化する。

### 1.2 削除理由

| # | 理由 | 詳細 |
|---|------|------|
| 1 | 統計の整合性問題 | Pips情報・RR比・最大DD・保有時間が正確に計算できない |
| 2 | データ構造の複雑化 | isBulkEntry判定ロジックが複数ファイルに散在 |
| 3 | Phase 1コンセプト | 「今日から始める人」向けのシンプルなシステム |

### 1.3 Phase 2での復活計画

過去データ移行機能はPhase 2（v2.0）で高度な機能として実装予定：
- CSV一括インポート
- Excel一括インポート
- MT4/MT5データ連携
- 新しい設計（isBulkEntryは使用しない）

---

## 2. 実施結果サマリー

### 2.1 作業完了日時

**2025-11-29 完了**

### 2.2 削減効果

| 項目 | Before | After | 削減 |
|------|--------|-------|------|
| トレードデータ | 53件 | 50件 | 3件削除 |
| script.js行数 | 5,225行 | 5,002行 | **223行** |
| モジュールファイル | 存在 | 削除 | **1ファイル** |
| scriptタグ | 2つ | 0 | **2つ** |
| isBulkEntry参照 | 13箇所 | 0 | **13箇所** |
| EventBusイベント | bulk:imported | なし | **1イベント** |

### 2.3 修正ファイル一覧

| # | ファイル | 修正内容 | 結果 |
|---|---------|---------|------|
| 1 | js/part7_modules/BulkImportModule.js | **ファイル削除** | ✅ |
| 2 | index.html | scriptタグ2つ削除 | ✅ |
| 3 | script.js | 一括入力関連関数削除（223行削減） | ✅ |
| 4 | js/part8_modules/StatisticsModule.js | bulk:importedリスナー削除 | ✅ |
| 5 | js/part2/TradeDetail.js | isBulkEntry判定削除（7箇所） | ✅ |
| 6 | js/part2/TradeList.js | isBulkData判定削除 | ✅ |
| 7 | js/yen-profit-loss/YenProfitLossModalModule.js | 一括入力データ注記削除 | ✅ |
| 8 | js/part2/bridge.js | isBulkEntry条件分岐削除 | ✅ |

### 2.4 存在しなかったファイル

| ファイル | 備考 |
|---------|------|
| js/part7/bulk-form-enhancement.js | 要件定義書v1.0〜v1.2に記載されていたが実際には存在しなかった |
| Part7_収支管理.js | 独立ファイルとして存在せず（script.jsに統合） |

---

## 3. 実施Phase詳細

### Phase 0: 事前準備 ✅

| Step | 内容 | 結果 |
|------|------|------|
| 0-1 | localStorageバックアップ | ✅ 完了 |
| 0-2 | 事前確認（53件、一括3件） | ✅ 確認済み |

### Phase 1: データ削除 ✅

| Step | 内容 | 結果 |
|------|------|------|
| 1-1 | 一括入力データ削除（3件） | ✅ 削除完了 |
| 1-2 | 削除確認（0件） | ✅ 確認済み |

**削除されたデータ**:

| # | ID | 通貨 | 損益 |
|---|---|------|------|
| 1 | bulk_1764284398612_0_saoorz9oi | XAU/USD | ¥49,900 |
| 2 | bulk_1764284436771_0_v6pii0xud | USD/JPY | ¥2,100 |
| 3 | bulk_1764284436771_1_lkaxa5eai | USD/JPY | ¥3,200 |

### Phase 2: ファイル削除 ✅

| Step | 内容 | 結果 |
|------|------|------|
| 2-1 | BulkImportModule.js削除 | ✅ 削除完了 |
| 2-2 | bulk-form-enhancement.js | ⚠️ 元々存在しない |

### Phase 3: index.html修正 ✅

| Step | 内容 | 結果 |
|------|------|------|
| 3-1 | scriptタグ2つ削除 | ✅ 完了 |
| 3-2 | 修正確認 | ✅ 確認済み |

**削除したscriptタグ**:
```html
<script src="js/part7_modules/BulkImportModule.js"></script>
<script src="js/part7_modules/bulk-form-enhancement.js"></script>
```

### Phase 4: JavaScript修正 ✅

| Step | ファイル | 内容 | 結果 |
|------|---------|------|------|
| 4-1 | script.js | 一括入力関数削除（223行削減） | ✅ |
| 4-2 | Part7_収支管理.js | スキップ（存在しない） | ✅ |
| 4-3 | StatisticsModule.js | bulk:importedリスナー削除 | ✅ |
| 4-4 | TradeDetail.js | isBulkEntry判定削除 | ✅ |
| 4-5 | TradeList.js | isBulkData判定削除 | ✅ |
| 4-6 | YenProfitLossModalModule.js | 注記削除 | ✅ |
| 4-7 | bridge.js | isBulkEntry条件削除 | ✅ |

**script.jsで削除された関数・変数**:
- `addBulkTradeRow()`
- `bulkTradeRowCount`
- `clearBulkTradeRow()`
- `editBulkTradeDetails()`
- `saveBulkDetails()`
- 一括入力セクションHTMLテンプレート
- サイドバーの一括入力タブボタン
- BulkImportModule存在チェック

### Phase 5: 最終確認 ✅

| 確認項目 | 結果 |
|---------|------|
| BulkImportModule削除 | ✅ |
| addBulkTradeRow削除 | ✅ |
| saveBulkTrades削除 | ✅ |
| editBulkTradeDetails削除 | ✅ |
| 全トレード数 | 50件 ✅ |
| 一括入力データ | 0件 ✅ |
| 10モジュール正常 | ✅ |
| 主要関数正常 | ✅ |

**最終手動テスト結果**:

| # | テスト項目 | 結果 |
|---|-----------|------|
| 1 | 6タブすべて表示 | ✅ |
| 2 | 新規エントリーでトレード保存 | ✅ |
| 3 | トレード一覧表示（50件） | ✅ |
| 4 | トレード詳細モーダル表示 | ✅ |
| 5 | 相場ノート機能 | ✅ |
| 6 | 分析タブ統計表示 | ✅ |
| 7 | 経費管理機能 | ✅ |
| 8 | CSV出力機能 | ✅ |
| 9 | 設定タブ | ✅ |
| 10 | コンソールエラー | ✅ なし |

### Phase 6: ドキュメント更新 ✅

| ドキュメント | 更新内容 | 結果 |
|-------------|---------|------|
| TASKS.md | タスク完了記録 | ✅ |
| MODULES.md | BulkImportModule削除、EventBus更新 | ✅ |
| OVERVIEW.md | ファイル構成更新 | ✅ |
| REFERENCE.md | 完了履歴追加 | ✅ |
| 機能一覧.md | 一括入力機能削除 | ✅ |
| docs/フォーム制御.md | 一括入力フロー削除、新知見追加 | ✅ |

---

## 4. 教訓・ベストプラクティス

### 4.1 機能削除時のチェックリスト

機能を完全削除する際は以下を確認：

| # | カテゴリ | 確認項目 |
|---|---------|---------|
| 1 | ファイル | モジュールファイル本体 |
| 2 | scriptタグ | index.htmlの読み込み |
| 3 | グローバル関数 | window.xxx登録 |
| 4 | EventBusリスナー | xxx.on('event', ...) |
| 5 | EventBus発火 | xxx.emit('event') |
| 6 | 判定フラグ | isXxx, hasXxx（複数ファイルに散在しやすい） |
| 7 | データ | localStorage内の該当データ |
| 8 | HTML/UI | 関連するDOM要素 |

### 4.2 今回の学び

1. **判定フラグは散在する**
   - `isBulkEntry`は7ファイル13箇所に存在
   - grepで全ファイル検索が必須

2. **存在しないファイルの記載**
   - MODULES.mdの情報が古い場合がある
   - 実際のファイル構成を確認してから作業

3. **段階的削除の重要性**
   - データ → ファイル → 参照コード の順
   - 各Stepで確認コードを実行

4. **別チャット修正指示方式**
   - 各ファイルは担当チャットで修正
   - 修正指示はダウンロードリンク付きで提供
   - 完了後にメインチャットで確認

### 4.3 Phase 1の設計思想

> **「機能削除は勇気がいるけど大事」**

- Trading Completeの価値は「正確に記録できる」こと
- 不完全なデータを作る機能より、シンプルで信頼できるシステム
- 高度な機能はPhase 2で正しく実装

---

## 5. 引き継ぎ事項

### 5.1 現在の状態

- 一括入力機能は**完全削除済み**
- トレード入力は「新規エントリータブから1件ずつ」のみ
- `isBulkEntry`プロパティは使用禁止

### 5.2 Phase 2（v2.0）での実装予定

| 機能 | 説明 |
|------|------|
| CSV一括インポート | 完全なデータ構造でインポート |
| Excel一括インポート | xlsx形式対応 |
| MT4/MT5データ連携 | トレード履歴の自動取り込み |
| ブローカーAPI連携 | リアルタイムデータ同期 |

### 5.3 実装時の注意

- 新しいフラグ名を使用（`isBulkEntry`は使用しない）
- 完全なデータ構造（pips, SL/TP含む）を必須に
- バリデーション強化
- エラーハンドリング充実

---

## 6. 関連ドキュメント

- [TASKS.md](./TASKS.md) - タスク管理
- [MODULES.md](./MODULES.md) - モジュール技術仕様
- [OVERVIEW.md](./OVERVIEW.md) - システム全体構造
- [REFERENCE.md](./REFERENCE.md) - 完了履歴・ガイドライン
- [docs/フォーム制御.md](./docs/フォーム制御.md) - フォーム制御・エラー対処

---

## 7. 作業ログ

### 2025-11-29 作業タイムライン

| 時刻 | 作業内容 |
|------|---------|
| - | Phase 0: 事前確認（53件、一括3件） |
| - | Phase 1: データ削除（3件→0件） |
| - | Phase 2: BulkImportModule.js削除 |
| - | Phase 3: index.html scriptタグ削除 |
| - | Phase 4-1: script.js修正（223行削減） |
| - | Phase 4-3: StatisticsModule.js修正 |
| - | Phase 4-4: TradeDetail.js修正 |
| - | Phase 4-5: TradeList.js修正 |
| - | Phase 4-6: YenProfitLossModalModule.js修正 |
| - | Phase 4-7: bridge.js修正 |
| - | Phase 5: 最終確認（全テスト合格） |
| - | Phase 6: ドキュメント更新完了 |

---

**ステータス: ✅ 完了**

*一括入力機能削除は正常に完了しました。Trading Complete Phase 1のシンプル化が達成されました。*

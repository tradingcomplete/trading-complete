# 相場ノート機能改善 - 要件定義書 v2.0（完了版）

**作成日**: 2025-11-27  
**最終更新**: 2025-11-27  
**優先度**: MEDIUM（ユーザビリティ向上）  
**目標**: 過去ノートの検索性向上と月ごとの情報整理を実現  
**技術方針**: NoteManagerModule拡張 + MODULES.md標準パターン準拠  
**状態**: ✅ 完了

---

## 📋 目次

1. [概要](#概要)
2. [機能1: キーワード検索機能](#機能1-キーワード検索機能)
3. [機能2: 月メモ機能（2段構成）](#機能2-月メモ機能2段構成)
4. [データ構造](#データ構造)
5. [UI設計](#ui設計)
6. [スマホ対応](#スマホ対応)
7. [実装ロードマップ](#実装ロードマップ)
8. [テスト結果](#テスト結果)
9. [修正したバグ](#修正したバグ)
10. [成果物](#成果物)

---

## 🎯 概要

### 背景・課題

1. **検索機能がない**: ノートが増えると「あのメモどこに書いたっけ？」が発生
2. **月ごとの情報整理がない**: アノマリーや重要イベントを毎回思い出す必要がある

### 解決策

| 機能 | 解決する課題 |
|------|-------------|
| キーワード検索 | 過去ノートから素早く情報を見つける |
| 月メモ（アノマリー） | 毎年繰り返される季節性情報を常時参照 |
| 月メモ（月次） | 当月のイベント・個人メモを常時参照 |

### ユーザーメリット

- 📍 過去の記録を瞬時に発見
- 🔄 毎年使えるアノマリー情報の蓄積
- 📅 月初の確認事項を常に把握

---

## 🔍 機能1: キーワード検索機能

### 1-1. 機能概要

| 項目 | 内容 |
|------|------|
| 検索対象 | メモ（memo）+ 相場観（marketView） |
| 検索方式 | ボタン押し式（入力確定後に検索） |
| 結果表示 | 日付 + マッチ箇所のプレビュー（LINE風） |
| UI形式 | モーダル表示 |

### 1-2. UI設計

```
┌─────────────────────────────────────────┐
│ 🔍 ノート検索                    [×]    │
├─────────────────────────────────────────┤
│ [____________________] [検索]           │
├─────────────────────────────────────────┤
│ 検索結果: 3件                           │
├─────────────────────────────────────────┤
│ 📅 2025/11/20                    [→]   │
│ ...ドル円は「買い」目線で見ていく...    │
├─────────────────────────────────────────┤
│ 📅 2025/11/15                    [→]   │
│ ...押し目「買い」を検討...              │
└─────────────────────────────────────────┘
※ キーワード部分はハイライト表示（<mark>タグ）
※ [→] クリックでそのノートにジャンプ
```

### 1-3. 実装メソッド

| メソッド | 役割 |
|---------|------|
| `searchNotes(keyword)` | キーワード検索実行 |
| `#stripHTML(html)` | HTMLタグ除去 |
| `#extractPreview(note, keyword)` | プレビュー抽出（前後20文字） |
| `openNoteSearchModal()` | モーダル表示 |
| `closeNoteSearchModal()` | モーダル非表示 |
| `executeNoteSearch()` | 検索実行・結果表示 |
| `#highlightKeyword(text, keyword)` | キーワードハイライト |
| `jumpToNoteFromSearch(dateStr)` | 検索結果からジャンプ |

---

## 📅 機能2: 月メモ機能（2段構成）

### 2-1. 機能概要

| 段 | 名称 | データ単位 | 用途 |
|----|------|-----------|------|
| 上段 | アノマリーメモ | 月のみ（1〜12） | 毎年共通の季節性情報 |
| 下段 | 月次メモ | 年月（2025-11） | その年固有のイベント・メモ |

### 2-2. 折りたたみ動作

| 状態 | アイコン | 意味 |
|------|---------|------|
| 閉じている | ▼ | 「下に開く」 |
| 開いている | ▲ | 「上に閉じる」 |

**初期状態**: 両方とも展開（▲表示）
**状態保存**: LocalStorageに保存（次回訪問時も維持）

### 2-3. 実装メソッド

| メソッド | 役割 |
|---------|------|
| `getCurrentMonthInfo()` | 現在選択中の月情報取得 |
| `getAnomalyMemo(month)` | アノマリーメモ取得 |
| `getMonthlyMemo(yearMonth)` | 月次メモ取得 |
| `saveAnomalyMemo(month, text)` | アノマリーメモ保存 |
| `saveMonthlyMemo(yearMonth, text)` | 月次メモ保存 |
| `getCollapseState(type)` | 折りたたみ状態取得 |
| `toggleCollapseState(type)` | 折りたたみ切替 |
| `updateMonthlyMemoDisplay()` | 月メモ表示更新 |
| `#applyCollapseState()` | 折りたたみ状態適用 |
| `toggleMonthlyMemoSection(type)` | UI折りたたみ切替 |
| `openMonthlyMemoEditModal(type)` | 編集モーダル表示 |
| `closeMonthlyMemoEditModal()` | 編集モーダル非表示 |
| `saveMonthlyMemoFromModal()` | モーダルから保存 |

---

## 💾 データ構造

### 3-1. 既存データ（notes）

```javascript
notes = {
    "2025-11-27": {
        date: "2025-11-27",
        memo: "今日のメモ...",
        marketView: "相場観...",
        images: [],
        createdAt: "2025-11-27T10:00:00Z",
        updatedAt: "2025-11-27T15:30:00Z"
    }
}
// LocalStorageキー: 'notes'
```

### 3-2. 新規データ（monthlyMemos）

```javascript
monthlyMemos = {
    anomaly: {
        "1": "・年始の薄商い",
        "11": "・感謝祭週は流動性低下",
        "12": "・クリスマス休暇"
    },
    monthly: {
        "2025-11": "・11/5 FOMC\n・11/28 感謝祭",
        "2025-12": "・12/13 日銀会合"
    }
}
// LocalStorageキー: 'monthlyMemos'
```

### 3-3. 折りたたみ状態

```javascript
monthlyMemoCollapseState = {
    anomaly: false,  // false = 展開
    monthly: false
}
// LocalStorageキー: 'monthlyMemoCollapseState'
```

---

## 🎨 UI設計（配置）

### 4-1. 全体レイアウト（PC）

```
┌─────────────────────────────────────────────────────────────┐
│ 📖 相場ノート                                               │
├─────────────────────────────────────────────────────────────┤
│ [🔍検索]  [◀] 2025-11-27 [▶] [今日]                        │
├─────────────────────────────────────────────────────────────┤
│ 📅 11月のメモ                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ▲ 🔄 アノマリー（毎年共通）                    [編集]  │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ ・感謝祭週は流動性低下...                           │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ ▲ 📝 2025年11月                                [編集]  │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ ・11/5 FOMC...                                      │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ノート入力エリア                                            │
├─────────────────────────────────────────────────────────────┤
│ 週間プレビュー                                              │
├─────────────────────────────────────────────────────────────┤
│ ノート詳細                                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 📱 スマホ対応

| 項目 | PC | スマホ |
|------|-----|-------|
| 検索ボタン | 「🔍 検索」テキスト付き | 「🔍」アイコンのみ |
| 月メモ初期状態 | 両方展開 | 両方展開 |
| 編集ボタン | テキスト「編集」 | 小型化 |
| 検索モーダル | 画面中央 | 全画面 |
| 月メモ編集モーダル | 画面中央 | 全画面 |

---

## 🛠️ 実装ロードマップ

### Phase 1: データ層実装 ✅ 完了

| タスク | 内容 |
|--------|------|
| 1-1 | monthlyMemosデータ読込・保存メソッド |
| 1-2 | getAnomalyMemo(month) API |
| 1-3 | getMonthlyMemo(yearMonth) API |
| 1-4 | saveAnomalyMemo(month, text) API |
| 1-5 | saveMonthlyMemo(yearMonth, text) API |
| 1-6 | 折りたたみ状態の読込・保存 |

### Phase 2: HTML追加 ✅ 完了

| タスク | 内容 |
|--------|------|
| 2-1 | 検索ボタン追加 |
| 2-2 | 月メモ表示エリア追加 |
| 2-3 | 検索モーダルHTML追加 |
| 2-4 | 月メモ編集モーダルHTML追加 |

### Phase 3: CSS追加 ✅ 完了

| タスク | 内容 |
|--------|------|
| 3-1 | 3_notes.css - 検索・月メモスタイル |
| 3-2 | 5_themes.css - ライトモード対応 |
| 3-3 | 6_responsive.css - スマホ対応 |

### Phase 4: JavaScript UI操作 ✅ 完了

| タスク | 内容 |
|--------|------|
| 4-1 | 月メモUI表示・更新メソッド |
| 4-2 | 検索モーダル操作メソッド |
| 4-3 | 月メモ編集モーダル操作メソッド |
| 4-4 | グローバル関数登録・初期化 |

### Phase 5: バグ修正・統合テスト ✅ 完了

| タスク | 内容 |
|--------|------|
| 5-1 | 折りたたみアイコン修正（▲/▼） |
| 5-2 | 日付変更時の月メモ更新連動 |
| 5-3 | 週間プレビュースクロール問題 |
| 5-4 | ノート保存バグ修正（CRITICAL） |
| 5-5 | カレンダー⇔週間プレビュー連動 |

---

## ✅ テスト結果

### 検索機能テスト

| # | テスト項目 | 結果 |
|---|-----------|------|
| 1 | 基本検索 | ✅ |
| 2 | 複数ヒット | ✅ |
| 3 | ヒットなし | ✅ |
| 4 | プレビュー表示 | ✅ |
| 5 | 結果クリック | ✅ |
| 6 | モーダル閉じる | ✅ |

### 月メモ機能テスト

| # | テスト項目 | 結果 |
|---|-----------|------|
| 1 | 初期表示 | ✅ |
| 2 | 折りたたみ（▲/▼） | ✅ |
| 3 | 編集（アノマリー） | ✅ |
| 4 | 編集（月次） | ✅ |
| 5 | 月変更連動 | ✅ |
| 6 | 空の表示 | ✅ |

### 既存機能への影響テスト

| # | テスト項目 | 結果 |
|---|-----------|------|
| 1 | 週間プレビュー表示 | ✅ |
| 2 | ノート保存・リロード | ✅ |
| 3 | カレンダー⇔週間プレビュー連動 | ✅ |
| 4 | ◀▶ボタン連動 | ✅ |
| 5 | 「今日」ボタン連動 | ✅ |

---

## 🐛 修正したバグ

### 1. ノート保存がリロードで消える 🔴 CRITICAL

**原因**: `#save()` 内で `window.saveNotes()` を呼んでおり、古いグローバル変数で上書き

**修正**: `window.saveNotes()` 呼び出しを削除

**詳細**: docs/フォーム制御.md 参照

---

### 2. カレンダー⇔週間プレビュー連動しない

**原因**: `noteDate` の `onchange` で `loadNoteForDate()` のみ呼んでいた

**修正**: `selectNoteDate(this.value)` に変更

---

### 3. 週間プレビューがスクロール表示

**原因**: `.weekly-preview` に `max-height: 500px` が設定されていた

**修正**: 3_notes.css で `max-height: none` を追加

---

### 4. 折りたたみアイコン切替不具合

**原因**: CSSの `transform: rotate(180deg)` とJSのアイコン変更が競合

**修正**: CSSのtransformを削除（JSで直接制御に統一）

---

### 5. 日付変更時に月メモが更新されない

**原因**: `setToday()` と `changeDate()` で連動処理が不足

**修正**: 両メソッドに `updateMonthlyMemoDisplay()` と `selectNoteDate()` を追加

---

## 📦 成果物

### 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| NoteManagerModule.js | 検索・月メモAPI追加（12メソッド） |
| index.html | 検索ボタン・月メモUI・モーダル追加、noteDate onchange修正 |
| styles/3_notes.css | 検索・月メモスタイル、週間プレビュー修正 |
| styles/5_themes.css | ライトモード対応 |
| styles/6_responsive.css | スマホ対応 |

### 新規LocalStorageキー

| キー | 用途 |
|-----|------|
| monthlyMemos | 月メモデータ |
| monthlyMemoCollapseState | 折りたたみ状態 |

### 工数

| Phase | 時間 |
|-------|------|
| Phase 1-4 | 5時間 |
| Phase 5（バグ修正） | 2時間 |
| **合計** | **7時間** |

---

## 📅 更新履歴

| バージョン | 更新日 | 主な変更点 |
|-----------|--------|-----------|
| v1.0 | 2025-11-27 | 初版作成 |
| v1.1 | 2025-11-27 | 実装進捗追加、判明した問題と解決策セクション追加 |
| v2.0 | 2025-11-27 | **完了版** - 全テスト完了、バグ修正完了 |

---

*この機能は2025-11-27に完了しました。*
# 画像説明欄追加 - 要件定義書 v1.8

**作成日**: 2026-01-17  
**更新日**: 2026-01-23（v1.8: 鉛筆マーク常時表示・バグ修正完了）  
**優先度**: MEDIUM（ユーザビリティ向上）  
**目標**: 画像に題名・説明を追加し、何の画像か一目で分かるようにする  
**技術方針**: MODULES.md標準パターン準拠  
**状態**: ✅ **完了**

---

## 📋 実装進捗サマリー

| Phase | 内容 | 状態 |
|-------|------|------|
| Phase 1 | imageUtils.js 基盤整備 | ✅ 完了 |
| Phase 2 | 画像追加モーダル改修（Step2追加） | ✅ 完了 |
| Phase 3 | サムネイル表示・拡大モーダル改修 | ✅ 完了 |
| Phase 4 | （Phase 3に統合） | ✅ 完了 |
| Phase 5 | 説明編集機能（✏️ボタン） | ✅ 完了 |
| Phase 6 | テスト・調整・バグ修正 | ✅ 完了 |
| Phase 7 | URL期限切れ問題対応 | ✅ 完了 |
| Phase 8 | 画像モーダル統合・デザイン統一 | ✅ **完了** |

---

## ✅ Phase 8: 画像モーダル統合・デザイン統一（完了）

### 概要
- Step2（imageAddStep2）を削除し、imageCaptionEditModalに統合
- 2つのモーダルのデザインを統一
- 編集モーダルに「画像を変更」「×」削除ボタン追加
- **全画面で鉛筆マーク（編集ボタン）表示**

### 8-A: モーダル統合

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-A-1 | Step2のHTML削除 | index.html | ✅ 完了 |
| 8-A-2 | showImageAddStep2をimageCaptionEditModal使用に変更 | script.js | ✅ 完了 |
| 8-A-3 | saveImageCaptionEditに追加モード対応 | script.js | ✅ 完了 |
| 8-A-4 | changeImageInEdit関数追加 | script.js | ✅ 完了 |

### 8-B: デザイン統一

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-B-1 | 編集モーダルに×削除ボタン追加 | index.html | ✅ 完了 |
| 8-B-2 | 「画像を変更」ボタンを表示に変更 | script.js | ✅ 完了 |
| 8-B-3 | deleteImageInEdit関数追加 | script.js | ✅ 完了 |
| 8-B-4 | NoteManagerModule.deleteImage追加 | NoteManagerModule.js | ✅ 完了 |
| 8-B-5 | CSSスタイル追加 | 6_responsive.css | ✅ 完了 |

### 8-C: 鉛筆マーク常時表示

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 8-C-1 | showImageModalWithCaption - 題名なしでも説明エリア表示 | script.js | ✅ 完了 |
| 8-C-2 | tradeChart1/2/3のonclick - context追加 | script.js | ✅ 完了 |
| 8-C-3 | openModalImageEdit - newEntry対応追加 | script.js | ✅ 完了 |

### 8-D: バグ修正

| # | タスク | 原因 | ファイル | 状態 |
|---|--------|------|---------|------|
| 8-D-1 | pendingImageTypeリセット問題 | closeImageAddModalで早期リセット | script.js | ✅ 完了 |
| 8-D-2 | 画像二重ネスト問題 | createImageDataにオブジェクトを渡す | script.js | ✅ 完了 |
| 8-D-3 | 相場ノート画像編集「画像が見つかりません」| NoteManagerModuleが旧形式を返す | script.js | ✅ 完了 |

---

## 📐 Phase 8 バグ修正詳細

### 8-D-1: pendingImageTypeリセット問題

**問題**: 画像追加時にpendingImageTypeがnullになり、画像が保存されない

**原因**: `closeImageAddModal`が「モーダルを閉じる」と「状態リセット」の2つの責任を持っていた

**修正（MODULES.md準拠：単一責任原則）**:
- `closeImageAddModal`から`pendingImageType = null`を削除
- 状態リセットは適切なタイミングで実施

### 8-D-2: 画像二重ネスト問題

**問題**: 新規エントリーで画像編集後、保存すると画像が消える

**原因**: 
```javascript
// 修正前: オブジェクトをそのままcreateImageDataに渡す
createImageData(imageSrc, title, description)
// 結果: {src: {src: "data:...", ...}, ...} ← 二重ネスト
```

**修正**:
```javascript
// 修正後: getImageSrcで実際の画像ソースを取り出す
const actualSrc = window.getImageSrc ? window.getImageSrc(imageSrc) : imageSrc;
createImageData(actualSrc, title, description)
// 結果: {src: "data:...", ...} ← 正常
```

### 8-D-3: 相場ノート画像編集「画像が見つかりません」

**問題**: 相場ノート画像の編集ボタンで「画像が見つかりません」エラー

**原因**: 
| 取得元 | データ形式 | title/description |
|--------|-----------|-------------------|
| NoteManagerModule.getNote() | URL文字列（旧形式） | ❌ なし |
| tempNoteEditImages | オブジェクト（新形式） | ✅ あり |

**修正**: `tempNoteEditImages`から優先的に取得
```javascript
const tempKey = 'noteEdit_' + (index + 1);
if (window.tempNoteEditImages && window.tempNoteEditImages[tempKey]) {
    imgData = window.tempNoteEditImages[tempKey];
}
```

---

## 📐 Phase 8 実装済み機能サマリー

### 画像モーダルフロー（統合後）

```
新規画像追加:
  Step1（画像選択）→ imageCaptionEditModal（題名・説明）→ 追加完了

既存画像編集:
  拡大モーダルから ✏️ → imageCaptionEditModal → 保存
  詳細モーダルから ✏️ → imageCaptionEditModal → 保存
```

### imageCaptionEditModal 機能

| 機能 | 追加モード | 編集モード |
|------|-----------|-----------|
| プレビュー画像 | ✅ | ✅ |
| 題名入力 | ✅ | ✅ |
| 説明入力 | ✅ | ✅ |
| 「画像を変更」ボタン | ✅ | ✅ |
| ×削除ボタン | キャンセル | 画像削除 |
| 保存ボタン | 「追加する」 | 「保存する」 |

### 鉛筆マーク表示対応画面

| 画面 | 修正前 | 修正後 |
|------|--------|--------|
| 新規エントリー画像 | ❌ なし | ✅ 表示 |
| 相場ノート編集画面 | ❌ 題名なしだと非表示 | ✅ 常時表示 |
| トレード詳細 | ✅ 表示 | ✅ 表示 |
| 週間プレビュー | ✅ 表示 | ✅ 表示 |

### 新規追加関数

| 関数 | ファイル | 説明 |
|------|---------|------|
| `changeImageInEdit()` | script.js | 画像を変更（Step1に戻る） |
| `deleteImageInEdit()` | script.js | 画像を削除（編集モード） |
| `deleteImage(dateStr, index)` | NoteManagerModule.js | ノート画像削除 |

---

## 📝 Phase 8 修正指示書一覧

| # | ファイル名 | 対象 |
|---|-----------|------|
| 1 | script_js_画像モーダル統合_修正指示書.md | Step2→統合モーダル |
| 2 | index_html_画像モーダル統合_修正指示書.md | Step2削除、モーダルHTML |
| 3 | 6_responsive_css_画像モーダル統合_修正指示書.md | 統合モーダルスタイル |
| 4 | index_html_デザイン統一_修正指示書.md | ×削除ボタン追加 |
| 5 | script_js_デザイン統一_修正指示書.md | deleteImageInEdit追加 |
| 6 | NoteManagerModule_デザイン統一_修正指示書.md | deleteImage追加 |
| 7 | 6_responsive_css_デザイン統一_修正指示書.md | ×ボタンスタイル |
| 8 | script_js_画像追加フロー修正_MODULES準拠_指示書.md | pendingImageType修正 |
| 9 | script_js_鉛筆マーク常時表示_MODULES準拠_修正指示書.md | 鉛筆マーク表示 |
| 10 | script_js_二重ネスト問題修正v2_MODULES準拠_指示書.md | 二重ネスト防止 |
| 11 | script_js_相場ノート画像編集修正_MODULES準拠_指示書.md | ノート画像取得 |

---

## ⚠️ Phase 8 重要な教訓

### 1. 関数の単一責任原則

`closeImageAddModal`が「モーダルを閉じる」と「状態リセット」の2つの責任を持っていたため、予期しない副作用が発生。

**教訓**: 関数は単一の責任のみを持つべき（MODULES.md準拠）

### 2. データ形式の一貫性

`createImageData`に渡すデータ形式が一貫していなかったため、二重ネスト問題が発生。

**教訓**: 関数に渡す前にデータ形式を正規化する

### 3. データ取得元の優先順位

NoteManagerModuleが旧形式を返す一方、tempNoteEditImagesには新形式が保存されていた。

**教訓**: 編集中のデータは一時変数（temp〜）から優先取得する

---

## 📁 Phase 8 修正ファイル一覧

| ファイル | 修正内容 |
|---------|---------|
| index.html | Step2削除、編集モーダル×ボタン追加 |
| script.js | showImageAddStep2統合、鉛筆マーク表示、バグ修正3件 |
| NoteManagerModule.js | deleteImage関数追加 |
| 6_responsive.css | ×ボタンスタイル、統合モーダルスタイル |

---

## 🎉 完了

画像説明欄追加機能の実装が完了しました。

**実装期間**: 2026-01-17 〜 2026-01-23（7日間）

**主な成果**:
- 画像に題名・説明を追加可能
- 全画面で題名が表示される
- 拡大表示で詳細を確認可能
- 各画面から編集可能（鉛筆マーク常時表示）
- Supabaseへの同期対応
- URL期限切れ時の自動更新対応
- 画像モーダル統合によるUX向上
- 画像削除機能追加

---

## 📋 以前のPhase（履歴）

<details>
<summary>Phase 1-7の詳細（クリックで展開）</summary>

### Phase 6 完了タスク一覧

#### 6-A: 新規エントリー画面

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-A-1 | chart-image-wrapper追加 | index.html | ✅ 完了 |
| 6-A-2 | caption要素を枠外に配置 | index.html | ✅ 完了 |
| 6-A-3 | handleProcessedImage修正 | script.js | ✅ 完了 |
| 6-A-4 | CSS調整（枠外題名） | 6_responsive.css | ✅ 完了 |

#### 6-B: トレード関連

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-B-1 | トレード記録タブの題名表示 | TradeList.js | ✅ 完了 |
| 6-B-2 | 拡大モーダルの完全非表示 | script.js | ✅ 完了 |
| 6-B-3 | トレード詳細モーダルの題名表示 | 6_responsive.css | ✅ 完了 |
| 6-B-4 | 拡大モーダルに編集ボタン追加 | index.html, script.js, CSS | ✅ 完了 |
| 6-B-5 | 編集後の戻り先制御 | script.js | ✅ 完了 |

#### 6-C: Supabase同期対応

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-C-1 | トレード画像 title/description保持 | SyncModule.js | ✅ 完了 |
| 6-C-2 | ノート画像 title/description保持 | SyncModule.js | ✅ 完了 |

#### 6-D: 相場ノート関連

| # | タスク | ファイル | 状態 |
|---|--------|---------|------|
| 6-D-1 | ノート編集画面の題名表示 | NoteManagerModule.js | ✅ 完了 |
| 6-D-2 | ノート編集画面の画像クリック拡大表示 | NoteManagerModule.js | ✅ 完了 |
| 6-D-3 | 週間プレビューの画像拡大表示 | NoteManagerModule.js | ✅ 完了 |

### Phase 7: URL期限切れ問題対応

| # | タスク | 状態 |
|---|--------|------|
| 7-1 | imageUtils.js v1.3.0作成（v1.1.0+v1.2.0統合） | ✅ 完了 |
| 7-2 | 既存データの復元スクリプト実行 | ✅ 完了 |
| 7-3 | path情報がDBに保存されることを確認 | ✅ 完了 |

</details>

---

## 📐 実装済み機能サマリー

### imageUtils.js v1.3.0

**基本関数**:
- `getImageSrc()` - 画像URLを取得
- `hasValidImage()` - 有効な画像か判定
- `isUrlImage()` - URL形式か判定
- `isBase64Image()` - Base64形式か判定

**説明機能（v1.2.0）**:
- `normalizeImageData()` - 画像データ正規化
- `getImageTitle()` - 題名を取得
- `getImageDescription()` - 説明を取得
- `createImageData()` - 画像データ作成
- `updateImageCaption()` - 題名・説明更新
- `hasImageCaption()` - 題名/説明があるか判定

**URL期限切れ処理（v1.1.0）**:
- `getUrlExpiration()` - URL有効期限を取得
- `isUrlExpired()` - 期限切れ判定（1時間余裕）
- `getValidImageSrc()` - 期限切れなら自動更新
- `refreshTradeImageUrls()` - トレード画像一括更新
- `refreshNoteImageUrls()` - ノート画像一括更新

### 画像データ構造

```javascript
// 完全な画像データ構造
{
    src: "https://...",           // 表示用URL
    url: "https://...",           // Supabase署名付きURL
    path: "userId/trades/xxx/chart1.jpg",  // ⚠️ 重要: 復元に必要
    title: "エントリー時の日足",
    description: "サポートラインブレイク",
    timestamp: "2026-01-22T..."
}
```

### 画面別機能

| 画面 | 題名表示 | 拡大表示 | 編集機能 | 削除機能 |
|------|---------|---------|---------|---------|
| 新規エントリー | ✅ 枠外 | ✅ | ✅ 鉛筆 | ✅ |
| トレード記録タブ | ✅ サムネイル下 | ✅ 題名・説明付き | ✅ 鉛筆 | ✅ |
| トレード詳細モーダル | ✅ 画像下 | ✅ 題名・説明付き | ✅ 鉛筆 | ✅ |
| 拡大モーダル | ✅ | - | ✅ 鉛筆 | ✅ |
| 相場ノート編集画面 | ✅ オーバーレイ | ✅ | ✅ 鉛筆 | ✅ |
| 相場ノート詳細 | ✅ 画像下 | ✅ 題名・説明付き | ✅ 鉛筆 | ✅ |
| 週間プレビュー | - | ✅ 題名・説明付き | ✅ 鉛筆 | ✅ |

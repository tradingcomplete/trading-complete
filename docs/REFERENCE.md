# REFERENCE.md 修正指示（統合版）

**作成日**: 2026-01-24
**対象期間**: 2026-01-15〜2026-01-24の全修正

---

## 修正1: ヘッダー更新（2行目）

**変更後:**
```
*更新日: 2026-01-24 | 用途: 開発ガイドライン・完了履歴・ベストプラクティス*
```

---

## 修正2: 2026年1月テーブルに追加（282行目の後）

以下の行を追加：

```markdown
| **01/15** | **Phase 5: 統合テスト・本番準備完了** | **CRITICAL** | **4h** | **機能・セキュリティ・エッジケース全テスト合格** | [詳細](#phase-5-統合テスト本番準備2026-01-15) |
| **01/15** | **レスポンシブ改善（ヘッダー・週間プレビュー・決済入力等）** | **MEDIUM** | **4h** | **横並び維持、max-height増加、フィールド幅統一、画像サイズ固定** | [詳細](#レスポンシブ改善2026-01-15) |
| **01/15** | **Pull-to-Refresh実装** | **LOW** | **1h** | **ページ最上部スワイプでリロード、iOS対応** | [詳細](#pull-to-refresh実装2026-01-15) |
| **01/15** | **決済記録モーダル改善** | **MEDIUM** | **1h** | **参考情報2列化、プレースホルダー短縮** | [詳細](#決済記録モーダル改善2026-01-15) |
| **01/17-23** | **画像説明欄追加機能（Phase 1-8完了）** | **MEDIUM** | **7日間** | **画像に題名・説明追加、全画面表示、モーダル統合** | [詳細](#画像説明欄追加機能) |
| **01/22** | **imageUtils.js v1.3.0リリース** | **HIGH** | **1h** | **v1.1.0+v1.2.0統合、URL期限切れ自動更新対応** | [詳細](#教訓24-imageutilsjsバージョン管理と画像データ構造) |
| **01/24** | **6_responsive.css 画像モーダル・iOS自動ズーム対応** | **MEDIUM** | **2h** | **拡大モーダル編集ボタン、詳細モーダル題名表示、iOS自動ズーム防止** | [詳細](#6_responsivecss-修正2026-01-24) |
```

---

## 修正3: 主な成果に追加（345行目付近、Supabase画像URL自動更新の後）

```markdown
- ✅ **Phase 5テスト完了: 機能12項目・セキュリティ3項目・エッジケース3項目全合格**
- 📱 **レスポンシブ改善（01/15）: ヘッダー横並び維持、週間プレビュー画像サムネイル、決済入力フィールド統一**
- 🔄 **Pull-to-Refresh実装: ページ最上部スワイプでリロード、iOS対応**
- 🖼️ **画像説明欄追加機能（01/17-23）: 題名・説明追加、全画面表示、Supabase同期対応**
- 📦 **imageUtils.js v1.3.0: v1.1.0+v1.2.0統合、URL期限切れ自動更新対応**
- 📱 **6_responsive.css修正（01/24）: 拡大モーダル編集ボタン、題名表示、iOS自動ズーム防止**
```

---

## 修正4: 完了タスク詳細に追加（「### 完了タスク詳細」の直後）

```markdown
#### ✅ 6_responsive.css 修正（2026-01-24）

**日付**: 2026-01-24 | **工数**: 2h | **優先度**: MEDIUM

**ファイルサイズ**: 4,628行 → 4,743行（+115行）

**修正内容**:

| # | 対象 | 内容 |
|---|------|------|
| 1 | 拡大モーダル編集ボタン | `.modal-caption-edit` 鉛筆ボタン、丸型半透明背景 |
| 2 | トレード詳細モーダル | `.detail-image-item` flexbox化、題名ellipsis対応 |
| 3 | ノート編集画面 | `.note-image-item .note-image-title` オーバーレイ表示 |
| 4 | 画像編集モーダル | `#changeImageInEditBtn` 画像変更ボタン |
| 5 | 画像モーダル統一 | `.preview-image-container`, `.delete-image-btn` |
| 6 | iOS自動ズーム防止 | 設定タブ入力フィールド font-size: 16px |

**iOS自動ズーム防止の詳細**:

| ブレークポイント | 対象 | 修正前 | 修正後 |
|-----------------|------|--------|--------|
| 768px以下 | 設定タブ input | 0.9rem | 16px |
| 480px以下 | 設定タブ input | 0.85rem | 16px |
| 480px以下 | セルフイメージ input | 0.8rem | 16px |
| 480px以下 | セルフイメージ date | 0.65rem | 16px |
| 360px以下 | 設定タブ input | 0.8rem | 16px |
| 360px以下 | セルフイメージ input | 0.75rem | 16px |
| 360px以下 | セルフイメージ date | 0.6rem | 16px |

**効果**: 自動ズーム❌ / ピンチズーム✅

---

#### ✅ 画像説明欄追加機能（2026-01-17〜23）

**完了日**: 2026-01-17〜2026-01-23（7日間）
**優先度**: MEDIUM
**成果物**: 要件定義書 v1.8

**実装内容（Phase 1-8）**:

| Phase | 内容 | 状態 |
|-------|------|------|
| 1 | 基盤実装（imageUtils.js拡張） | ✅ 完了 |
| 2 | 新規エントリータブUI | ✅ 完了 |
| 3 | トレード記録一覧での題名表示 | ✅ 完了 |
| 4 | 詳細モーダルでの表示 | ✅ 完了 |
| 5 | 拡大モーダルでの編集機能 | ✅ 完了 |
| 6 | 相場ノート対応 | ✅ 完了 |
| 7 | Supabase同期・URL期限切れ対応 | ✅ 完了 |
| 8 | 画像モーダル統合・デザイン統一 | ✅ 完了 |

**修正ファイル**:
- imageUtils.js v1.3.0（v1.1.0+v1.2.0統合）
- TradeEntry.js, TradeDetail.js, TradeList.js
- NoteManagerModule.js
- SyncModule.js
- 6_responsive.css

---

#### ✅ Phase 5: 統合テスト・本番準備（2026-01-15）

**完了日**: 2026-01-15

| Step | 内容 | 結果 |
|------|------|------|
| 5.1 | 機能テスト（12項目） | ✅ 合格 |
| 5.2 | セキュリティテスト（3項目） | ✅ 合格 |
| 5.3 | エッジケーステスト（3項目） | ✅ 合格（1件制限あり） |
| 5.4 | 本番環境準備確認 | ✅ 合格 |

**既知の制限（リリースノート記載）**:
1. オフライン中の保存はリロードで消失（v1.1対応予定）
2. iOS Safari goalsボタン問題（調査中）

---

#### ✅ レスポンシブ改善（2026-01-15）

**日付**: 2026-01-15 | **工数**: 4h | **優先度**: MEDIUM

**修正ファイル**: 6_responsive.css, 1_base.css, NoteManagerModule.js, TradeExit.js

---

#### ✅ Pull-to-Refresh実装（2026-01-15）

**日付**: 2026-01-15 | **工数**: 1h | **優先度**: LOW

**機能**: ページ最上部で下スワイプでリロード、緑色インジケーター表示、iOS対応

**実装ファイル**: script.js - `initPullToRefresh()`関数追加

---
```

---

## 修正5: 教訓24-27を追加（教訓23の後、Part VIの前）

```markdown
---

### 教訓24: 関数の単一責任原則

**問題**: `closeImageAddModal`が「モーダルを閉じる」と「状態リセット」の2つの責任を持っていたため、予期しない副作用が発生。

**解決策**: 関数は単一の責任のみを持つべき。複数の処理が必要な場合は、それぞれ別の関数に分離する。

---

### 教訓25: データ形式の一貫性

**問題**: `createImageData`に渡すデータ形式が一貫していなかったため、二重ネスト問題が発生。

**解決策**: 関数に渡す前にデータ形式を正規化する。入力データの検証を必ず行う。

---

### 教訓26: データ取得元の優先順位

**問題**: NoteManagerModuleが旧形式を返す一方、tempNoteEditImagesには新形式が保存されていた。

**解決策**: 編集中のデータは一時変数（temp〜）から優先取得する。データソースの優先順位を明確にドキュメント化する。

---

### 教訓27: iOS自動ズーム防止（font-size: 16px）

**問題**: iOSのSafariで入力フィールドをタップすると、自動的にズームされてしまう。

**原因**: iOSは`font-size`が16px未満の入力フィールドをタップすると、ユーザビリティのために自動ズームする。

**解決策**:
```css
/* iOSで入力時の自動ズームを防ぐ */
input[type="text"],
input[type="date"],
textarea,
select {
    font-size: 16px !important;
}
```

**注意点**:
- `rem`や`em`ではなく、明示的に`16px`を指定
- ピンチズーム（ユーザー操作）は引き続き可能

---
```

---

## 修正6: 関連成果物テーブルに追加（Part VI内、1989行目付近）

```markdown
| 2026-01-22 | imageUtils.js v1.3.0 | v1.1.0+v1.2.0統合、画像説明欄対応 |
| 2026-01-24 | 6_responsive.css | 画像モーダル・iOS自動ズーム対応（+115行） |
```

---

## 修正7: 最終更新行を更新（ファイル末尾）

**変更後:**
```
*最終更新: 2026-01-24 | ドキュメントバージョン: 5.2.0（画像説明欄・6_responsive.css修正・教訓24-27追加）*
```

---

*以上*
